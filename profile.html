<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#e85d04">
  <title>ë‚´ í”„ë¡œí•„ â€” CodeDuck</title>
  <meta name="description" content="ì½”ë“œë•ì¿  í”„ë¡œí•„ ìˆ˜ì • í˜ì´ì§€">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="images/og-thumbnail.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --orange:    #e85d04;
      --orange-dk: #c24e03;
      --orange-lt: #fff7f0;
      --bg:        #f4f5f7;
      --bg-card:   #ffffff;
      --border:    #e5e7eb;
      --text:      #1a1a2e;
      --text-sub:  #6b7280;
      --radius:    14px;
      --shadow:    0 2px 16px rgba(0,0,0,.08);
    }

    body {
      font-family: 'Noto Sans KR', 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* â”€â”€ í—¤ë” â”€â”€ */
    .auth-header {
      background: #fff;
      border-bottom: 1px solid var(--border);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo-link {
      display: flex; align-items: center; gap: 8px;
      text-decoration: none;
    }
    .logo-icon { font-size: 1.5rem; }
    .logo-text { font-size: 1.2rem; font-weight: 900; color: var(--text); letter-spacing: -0.5px; }
    .logo-text span { color: var(--orange); }
    .back-link {
      font-size: 0.88rem; color: var(--text-sub);
      text-decoration: none; display: flex; align-items: center; gap: 5px;
    }
    .back-link:hover { color: var(--orange); }

    /* â”€â”€ ë©”ì¸ â”€â”€ */
    .profile-main {
      max-width: 640px;
      margin: 0 auto;
      padding: 36px 16px 60px;
    }

    /* â”€â”€ í”„ë¡œí•„ í—¤ë” ì¹´ë“œ â”€â”€ */
    .profile-hero {
      background: linear-gradient(135deg, #fff7f0 0%, #ffffff 100%);
      border: 1px solid #fde8d0;
      border-radius: var(--radius);
      padding: 28px 28px 24px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: var(--shadow);
    }
    .avatar-circle {
      width: 72px; height: 72px;
      background: linear-gradient(135deg, #e85d04, #f59e0b);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 2rem;
      color: #fff;
      font-weight: 900;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(232,93,4,.3);
    }
    .hero-info { flex: 1; min-width: 0; }
    .hero-nickname {
      font-size: 1.4rem; font-weight: 900;
      letter-spacing: -0.5px;
      margin-bottom: 4px;
    }
    .hero-email {
      font-size: 0.85rem; color: var(--text-sub);
      margin-bottom: 8px;
    }
    .hero-tags { display: flex; flex-wrap: wrap; gap: 6px; }
    .hero-tag {
      font-size: 0.78rem; font-weight: 600;
      padding: 3px 10px;
      border-radius: 20px;
      background: var(--orange-lt);
      color: var(--orange);
      border: 1px solid #fde8d0;
    }
    .hero-tag.gender { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
    .hero-tag.career { background: #f0fdf4; color: #16a34a; border-color: #bbf7d0; }

    /* â”€â”€ ì„¹ì…˜ ì¹´ë“œ â”€â”€ */
    .profile-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      overflow: hidden;
    }
    .card-header {
      padding: 16px 22px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-header-icon {
      width: 32px; height: 32px;
      background: var(--orange-lt);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.95rem;
      color: var(--orange);
    }
    .card-header-title {
      font-size: 1rem; font-weight: 800;
      letter-spacing: -0.3px;
    }
    .card-body { padding: 20px 22px; }

    /* â”€â”€ í¼ ê³µí†µ â”€â”€ */
    .form-group { margin-bottom: 18px; }
    .form-group:last-child { margin-bottom: 0; }
    .form-label {
      display: block;
      font-size: 0.85rem; font-weight: 700;
      margin-bottom: 7px; color: var(--text);
    }
    .form-label .required { color: var(--orange); margin-left: 3px; }
    .form-label .optional { font-size: 0.78rem; font-weight: 400; color: var(--text-sub); margin-left: 4px; }
    .form-input {
      width: 100%; padding: 11px 14px;
      border: 1.5px solid var(--border);
      border-radius: 10px;
      font-size: 0.95rem; font-family: inherit;
      color: var(--text); background: #fafafa;
      transition: border-color .18s, box-shadow .18s;
      outline: none;
    }
    .form-input:focus {
      border-color: var(--orange);
      box-shadow: 0 0 0 3px rgba(232,93,4,.12);
      background: #fff;
    }
    .form-input:disabled {
      background: #f3f4f6; color: var(--text-sub); cursor: not-allowed;
    }
    .form-hint { font-size: 0.78rem; color: var(--text-sub); margin-top: 5px; }
    .form-error { font-size: 0.8rem; color: #ef4444; margin-top: 5px; display: none; }
    .form-error.show { display: block; }

    /* â”€â”€ ì„±ë³„ â”€â”€ */
    .gender-group { display: flex; gap: 10px; }
    .gender-option { flex: 1; position: relative; }
    .gender-option input[type=radio] { position: absolute; opacity: 0; width: 0; height: 0; }
    .gender-option label {
      display: flex; align-items: center; justify-content: center; gap: 6px;
      padding: 10px 12px; border: 1.5px solid var(--border);
      border-radius: 10px; cursor: pointer;
      font-size: 0.9rem; font-weight: 500;
      transition: all .18s; background: #fafafa; user-select: none;
    }
    .gender-option input:checked + label {
      border-color: var(--orange); background: var(--orange-lt);
      color: var(--orange); font-weight: 700;
    }
    .gender-option label:hover { border-color: #fdba74; background: var(--orange-lt); }

    /* â”€â”€ íŒŒíŠ¸ â”€â”€ */
    .parts-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    @media (max-width: 400px) { .parts-grid { grid-template-columns: repeat(2, 1fr); } }
    .part-option { position: relative; }
    .part-option input[type=checkbox] { position: absolute; opacity: 0; width: 0; height: 0; }
    .part-option label {
      display: flex; align-items: center; gap: 6px;
      padding: 9px 12px; border: 1.5px solid var(--border);
      border-radius: 9px; cursor: pointer;
      font-size: 0.85rem; font-weight: 500;
      transition: all .18s; background: #fafafa; user-select: none;
    }
    .part-option input:checked + label {
      border-color: var(--orange); background: var(--orange-lt);
      color: var(--orange); font-weight: 700;
    }
    .part-option label:hover { border-color: #fdba74; background: var(--orange-lt); }

    /* â”€â”€ select â”€â”€ */
    .form-select {
      width: 100%; padding: 11px 14px;
      border: 1.5px solid var(--border); border-radius: 10px;
      font-size: 0.95rem; font-family: inherit;
      color: var(--text); background: #fafafa;
      transition: border-color .18s; outline: none; appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 12px center; padding-right: 38px;
    }
    .form-select:focus { border-color: var(--orange); box-shadow: 0 0 0 3px rgba(232,93,4,.12); }

    /* â”€â”€ ì €ì¥ ë²„íŠ¼ â”€â”€ */
    .btn-save {
      width: 100%; padding: 14px;
      background: var(--orange); color: #fff;
      border: none; border-radius: 11px;
      font-size: 1rem; font-weight: 700; font-family: inherit;
      cursor: pointer; transition: background .18s, transform .12s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-save:hover { background: var(--orange-dk); transform: translateY(-1px); }
    .btn-save:disabled { background: #fdba74; cursor: not-allowed; transform: none; }

    /* â”€â”€ ìœ„í—˜ êµ¬ì—­ (ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ / ë¡œê·¸ì•„ì›ƒ) â”€â”€ */
    .danger-row {
      display: flex; gap: 10px; flex-wrap: wrap;
    }
    .btn-secondary {
      flex: 1; min-width: 140px; padding: 12px;
      background: #f3f4f6; color: var(--text-sub);
      border: 1.5px solid var(--border); border-radius: 10px;
      font-size: 0.9rem; font-weight: 600; font-family: inherit;
      cursor: pointer; transition: all .18s;
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn-secondary:hover { background: #e5e7eb; color: var(--text); }
    .btn-danger {
      flex: 1; min-width: 140px; padding: 12px;
      background: #fef2f2; color: #dc2626;
      border: 1.5px solid #fca5a5; border-radius: 10px;
      font-size: 0.9rem; font-weight: 600; font-family: inherit;
      cursor: pointer; transition: all .18s;
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn-danger:hover { background: #fee2e2; }

    /* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€ */
    .toast {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(80px);
      background: #1e2433; color: #fff;
      padding: 12px 22px; border-radius: 12px;
      font-size: 0.9rem; font-weight: 600;
      box-shadow: 0 4px 20px rgba(0,0,0,.25);
      z-index: 9999; transition: transform .3s ease;
      white-space: nowrap;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* â”€â”€ ë¡œë”© ìŠ¤í”¼ë„ˆ â”€â”€ */
    .spinner {
      width: 18px; height: 18px;
      border: 2.5px solid rgba(255,255,255,.4);
      border-top-color: #fff; border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ ìŠ¤ì¼ˆë ˆí†¤ ë¡œë”© â”€â”€ */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.4s infinite;
      border-radius: 8px;
    }
    @keyframes shimmer { to { background-position: -200% 0; } }

    /* â”€â”€ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      display: none; align-items: center; justify-content: center;
      z-index: 999; padding: 16px;
    }
    .modal-overlay.show { display: flex; }
    .modal-box {
      background: #fff; border-radius: 14px;
      padding: 28px; width: 100%; max-width: 360px;
      box-shadow: 0 8px 32px rgba(0,0,0,.18);
    }
    .modal-title { font-size: 1.1rem; font-weight: 900; margin-bottom: 6px; }
    .modal-desc { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 18px; line-height: 1.6; }
    .modal-input {
      width: 100%; padding: 11px 14px;
      border: 1.5px solid var(--border); border-radius: 10px;
      font-size: 0.92rem; font-family: inherit; margin-bottom: 10px; outline: none;
    }
    .modal-input:focus { border-color: var(--orange); }
    .modal-btns { display: flex; gap: 8px; margin-top: 4px; }
    .modal-btns .btn-cancel {
      flex: 1; padding: 11px; background: #f3f4f6; border: none;
      border-radius: 9px; font-family: inherit; font-size: 0.9rem;
      font-weight: 600; cursor: pointer; color: var(--text-sub);
    }
    .modal-btns .btn-confirm {
      flex: 2; padding: 11px; background: var(--orange); border: none;
      border-radius: 9px; font-family: inherit; font-size: 0.9rem;
      font-weight: 700; cursor: pointer; color: #fff;
    }
    .modal-btns .btn-confirm:hover { background: var(--orange-dk); }
    .modal-msg { font-size: 0.82rem; margin-top: 10px; padding: 8px 12px; border-radius: 8px; display: none; }
    .modal-msg.success { background: #f0fdf4; color: #166534; display: block; }
    .modal-msg.error   { background: #fef2f2; color: #dc2626; display: block; }

    /* â”€â”€ ê°€ì…ì¼ / í†µê³„ â”€â”€ */
    .stat-row {
      display: flex; gap: 12px; flex-wrap: wrap;
    }
    .stat-box {
      flex: 1; min-width: 100px;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 10px; padding: 12px 14px; text-align: center;
    }
    .stat-val { font-size: 1.3rem; font-weight: 900; color: var(--orange); }
    .stat-lbl { font-size: 0.75rem; color: var(--text-sub); margin-top: 2px; }

    /* ê¸€ë¡œë²Œ ì—ëŸ¬ */
    .global-error {
      background: #fef2f2; border: 1px solid #fca5a5;
      border-radius: 10px; padding: 12px 16px;
      font-size: 0.88rem; color: #dc2626;
      margin-bottom: 16px; display: none;
    }
    .global-error.show { display: block; }
  </style>
</head>
<body>

  <!-- í—¤ë” -->
  <header class="auth-header">
    <a href="index.html" class="logo-link" aria-label="ì½”ë“œë•ì¿  í™ˆìœ¼ë¡œ">
      <span class="logo-icon">ğŸ¦†</span>
      <span class="logo-text">Code<span>ducku</span></span>
    </a>
    <a href="community.html" class="back-link">
      <i class="fas fa-arrow-left"></i> ì»¤ë®¤ë‹ˆí‹°ë¡œ
    </a>
  </header>

  <!-- ë©”ì¸ -->
  <main class="profile-main">

    <!-- í”„ë¡œí•„ íˆì–´ë¡œ -->
    <div class="profile-hero" id="profileHero">
      <div class="avatar-circle" id="avatarCircle">ğŸ¦†</div>
      <div class="hero-info">
        <div class="hero-nickname" id="heroNickname">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div class="hero-email" id="heroEmail"></div>
        <div class="hero-tags" id="heroTags"></div>
      </div>
    </div>

    <!-- ê¸°ë³¸ ì •ë³´ ìˆ˜ì • ì¹´ë“œ -->
    <div class="profile-card">
      <div class="card-header">
        <div class="card-header-icon"><i class="fas fa-user"></i></div>
        <div class="card-header-title">ê¸°ë³¸ ì •ë³´ ìˆ˜ì •</div>
      </div>
      <div class="card-body">
        <div class="global-error" id="globalError"></div>

        <!-- ì´ë©”ì¼ (ìˆ˜ì • ë¶ˆê°€) -->
        <div class="form-group">
          <label class="form-label">ì´ë©”ì¼ <span class="optional">(ë³€ê²½ ë¶ˆê°€)</span></label>
          <input type="email" class="form-input" id="emailField" disabled>
        </div>

        <!-- ë‹‰ë„¤ì„ -->
        <div class="form-group">
          <label class="form-label" for="nickname">ë‹‰ë„¤ì„ <span class="required">*</span></label>
          <input type="text" id="nickname" class="form-input" maxlength="20" placeholder="2~20ì">
          <div class="form-hint">ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ì‚¬ìš©í•  ì´ë¦„ì´ì—ìš”</div>
          <div class="form-error" id="nicknameError">ë‹‰ë„¤ì„ì€ 2~20ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
        </div>

        <!-- ì„±ë³„ -->
        <div class="form-group">
          <label class="form-label">ì„±ë³„ <span class="required">*</span></label>
          <div class="gender-group">
            <div class="gender-option">
              <input type="radio" id="genderMale" name="gender" value="male">
              <label for="genderMale">â™‚ ë‚¨ì„±</label>
            </div>
            <div class="gender-option">
              <input type="radio" id="genderFemale" name="gender" value="female">
              <label for="genderFemale">â™€ ì—¬ì„±</label>
            </div>
            <div class="gender-option">
              <input type="radio" id="genderOther" name="gender" value="other">
              <label for="genderOther">â— ê¸°íƒ€</label>
            </div>
          </div>
          <div class="form-error" id="genderError">ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
        </div>

        <!-- íŒŒíŠ¸ -->
        <div class="form-group">
          <label class="form-label">ë‚˜ì˜ íŒŒíŠ¸ <span class="required">*</span> <span class="optional">(ì¤‘ë³µ ì„ íƒ)</span></label>
          <div class="parts-grid">
            <div class="part-option"><input type="checkbox" id="partVocal"    name="parts" value="vocal">   <label for="partVocal">ğŸ¤ ë³´ì»¬</label></div>
            <div class="part-option"><input type="checkbox" id="partGuitar"   name="parts" value="guitar">  <label for="partGuitar">ğŸ¸ ê¸°íƒ€</label></div>
            <div class="part-option"><input type="checkbox" id="partBass"     name="parts" value="bass">    <label for="partBass">ğŸµ ë² ì´ìŠ¤</label></div>
            <div class="part-option"><input type="checkbox" id="partKeyboard" name="parts" value="keyboard"><label for="partKeyboard">ğŸ¹ í‚¤ë³´ë“œ</label></div>
            <div class="part-option"><input type="checkbox" id="partDrums"    name="parts" value="drums">   <label for="partDrums">ğŸ¥ ë“œëŸ¼</label></div>
            <div class="part-option"><input type="checkbox" id="partDJ"       name="parts" value="dj">      <label for="partDJ">ğŸ§ DJ</label></div>
            <div class="part-option"><input type="checkbox" id="partViolin"   name="parts" value="violin">  <label for="partViolin">ğŸ» ë°”ì´ì˜¬ë¦°</label></div>
            <div class="part-option"><input type="checkbox" id="partFlute"    name="parts" value="flute">   <label for="partFlute">ğŸ¶ í”Œë£¨íŠ¸</label></div>
            <div class="part-option"><input type="checkbox" id="partOther"    name="parts" value="other">   <label for="partOther">ğŸ¼ ê¸°íƒ€ì•…ê¸°</label></div>
          </div>
          <div class="form-error" id="partsError">íŒŒíŠ¸ë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
        </div>

        <!-- ê²½ë ¥ -->
        <div class="form-group">
          <label class="form-label" for="career">ìŒì•… ê²½ë ¥ <span class="optional">(ì„ íƒ)</span></label>
          <select id="career" class="form-select">
            <option value="">ê²½ë ¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
            <option value="beginner">ì…ë¬¸ (1ë…„ ë¯¸ë§Œ)</option>
            <option value="junior">ì´ˆê¸‰ (1~3ë…„)</option>
            <option value="intermediate">ì¤‘ê¸‰ (3~5ë…„)</option>
            <option value="senior">ê³ ê¸‰ (5~10ë…„)</option>
            <option value="expert">ì „ë¬¸ê°€ (10ë…„ ì´ìƒ)</option>
          </select>
        </div>

        <button class="btn-save" id="saveBtn" onclick="saveProfile()">
          <i class="fas fa-save"></i> ë³€ê²½ì‚¬í•­ ì €ì¥
        </button>
      </div>
    </div>

    <!-- ê³„ì • ê´€ë¦¬ ì¹´ë“œ -->
    <div class="profile-card">
      <div class="card-header">
        <div class="card-header-icon"><i class="fas fa-shield-alt"></i></div>
        <div class="card-header-title">ê³„ì • ê´€ë¦¬</div>
      </div>
      <div class="card-body">
        <div class="danger-row">
          <button class="btn-secondary" onclick="openPwModal()">
            <i class="fas fa-key"></i> ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
          </button>
          <button class="btn-secondary" onclick="doLogout()">
            <i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ
          </button>
        </div>
      </div>
    </div>

  </main>

  <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
  <div class="modal-overlay" id="pwModal">
    <div class="modal-box">
      <div class="modal-title">ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
      <p class="modal-desc">ê°€ì…í•œ ì´ë©”ì¼ë¡œ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤.</p>
      <div class="modal-btns">
        <button class="btn-cancel" onclick="document.getElementById('pwModal').classList.remove('show')">ì·¨ì†Œ</button>
        <button class="btn-confirm" onclick="sendPwReset()">
          <i class="fas fa-paper-plane"></i> ë©”ì¼ ë°œì†¡
        </button>
      </div>
      <div class="modal-msg" id="pwModalMsg"></div>
    </div>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div class="toast" id="toast"></div>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="js/auth.js"></script>
  <script>
    const PART_ICONS = {
      vocal:'ğŸ¤', guitar:'ğŸ¸', bass:'ğŸµ', keyboard:'ğŸ¹',
      drums:'ğŸ¥', dj:'ğŸ§', violin:'ğŸ»', flute:'ğŸ¶', other:'ğŸ¼'
    };
    const PART_KO = {
      vocal:'ë³´ì»¬', guitar:'ê¸°íƒ€', bass:'ë² ì´ìŠ¤', keyboard:'í‚¤ë³´ë“œ',
      drums:'ë“œëŸ¼', dj:'DJ', violin:'ë°”ì´ì˜¬ë¦°', flute:'í”Œë£¨íŠ¸', other:'ê¸°íƒ€ì•…ê¸°'
    };
    const GENDER_KO = { male:'ë‚¨ì„±', female:'ì—¬ì„±', other:'ê¸°íƒ€' };
    const CAREER_KO = {
      beginner:'ì…ë¬¸', junior:'ì´ˆê¸‰', intermediate:'ì¤‘ê¸‰',
      senior:'ê³ ê¸‰', expert:'ì „ë¬¸ê°€'
    };

    let currentUser = null;
    let currentProfile = null;

    // â”€â”€ í˜ì´ì§€ ì´ˆê¸°í™” â”€â”€
    async function init() {
      const session = await getSession();
      if (!session) {
        location.href = 'login.html?redirect=profile.html';
        return;
      }
      currentUser = session.user;
      currentProfile = await getProfile(currentUser.id);

      if (!currentProfile) {
        showToast('âŒ í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return;
      }
      fillForm();
      updateHero();
    }

    // â”€â”€ í¼ ì±„ìš°ê¸° â”€â”€
    function fillForm() {
      const p = currentProfile;
      document.getElementById('emailField').value  = currentUser.email;
      document.getElementById('nickname').value    = p.nickname || '';
      document.getElementById('career').value      = p.career   || '';

      // ì„±ë³„
      const genderRadio = document.querySelector(`input[name="gender"][value="${p.gender}"]`);
      if (genderRadio) genderRadio.checked = true;

      // íŒŒíŠ¸
      document.querySelectorAll('input[name="parts"]').forEach(cb => {
        cb.checked = Array.isArray(p.parts) && p.parts.includes(cb.value);
      });
    }

    // â”€â”€ íˆì–´ë¡œ ì—…ë°ì´íŠ¸ â”€â”€
    function updateHero() {
      const p = currentProfile;
      const nick = p.nickname || currentUser.email.split('@')[0];

      // ì•„ë°”íƒ€ ì´ë‹ˆì…œ
      document.getElementById('avatarCircle').textContent = nick.charAt(0).toUpperCase();
      document.getElementById('heroNickname').textContent = nick;
      document.getElementById('heroEmail').textContent    = currentUser.email;

      // íƒœê·¸
      const tags = [];
      if (p.gender) tags.push(`<span class="hero-tag gender">${GENDER_KO[p.gender] || p.gender}</span>`);
      if (Array.isArray(p.parts)) {
        p.parts.forEach(pt => {
          tags.push(`<span class="hero-tag">${PART_ICONS[pt] || ''} ${PART_KO[pt] || pt}</span>`);
        });
      }
      if (p.career) tags.push(`<span class="hero-tag career">ğŸµ ${CAREER_KO[p.career] || p.career}</span>`);
      document.getElementById('heroTags').innerHTML = tags.join('');
    }

    // â”€â”€ ì €ì¥ â”€â”€
    async function saveProfile() {
      const nickname = document.getElementById('nickname').value.trim();
      const gender   = document.querySelector('input[name="gender"]:checked')?.value || '';
      const parts    = [...document.querySelectorAll('input[name="parts"]:checked')].map(c => c.value);
      const career   = document.getElementById('career').value;

      // ì—ëŸ¬ ì´ˆê¸°í™”
      document.querySelectorAll('.form-error').forEach(el => el.classList.remove('show'));
      document.getElementById('globalError').classList.remove('show');

      let valid = true;
      if (nickname.length < 2 || nickname.length > 20) {
        document.getElementById('nicknameError').classList.add('show'); valid = false;
      }
      if (!gender) {
        document.getElementById('genderError').classList.add('show'); valid = false;
      }
      if (parts.length === 0) {
        document.getElementById('partsError').classList.add('show'); valid = false;
      }
      if (!valid) return;

      const btn = document.getElementById('saveBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> ì €ì¥ ì¤‘...';

      try {
        const sb = getClient();
        const { error } = await sb.from('profiles').update({
          nickname, gender, parts, career: career || null
        }).eq('id', currentUser.id);

        if (error) throw error;

        // ë¡œì»¬ ê°±ì‹ 
        currentProfile = { ...currentProfile, nickname, gender, parts, career };
        updateHero();
        showToast('âœ… í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      } catch (err) {
        console.error('[Profile] save error:', err);
        const errEl = document.getElementById('globalError');
        errEl.textContent = 'âŒ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        errEl.classList.add('show');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save"></i> ë³€ê²½ì‚¬í•­ ì €ì¥';
      }
    }

    // â”€â”€ ë¡œê·¸ì•„ì›ƒ â”€â”€
    async function doLogout() {
      await signOut();
      location.href = 'index.html';
    }

    // â”€â”€ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ â”€â”€
    function openPwModal() {
      document.getElementById('pwModal').classList.add('show');
      document.getElementById('pwModalMsg').className = 'modal-msg';
    }

    async function sendPwReset() {
      const sb = getClient();
      const { error } = await sb.auth.resetPasswordForEmail(currentUser.email, {
        redirectTo: `${location.origin}/reset-password.html`
      });
      const msgEl = document.getElementById('pwModalMsg');
      if (error) {
        msgEl.textContent = 'âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        msgEl.className = 'modal-msg error';
      } else {
        msgEl.textContent = `âœ… ${currentUser.email} ë¡œ ì¬ì„¤ì • ë§í¬ë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤!`;
        msgEl.className = 'modal-msg success';
      }
    }

    // â”€â”€ í† ìŠ¤íŠ¸ â”€â”€
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    // ì´ˆê¸°í™”
    init();
  </script>
</body>
</html>
