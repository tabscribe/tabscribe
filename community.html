<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#e85d04">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="icon" href="images/og-thumbnail.png" type="image/png">
    <link rel="apple-touch-icon" href="images/og-thumbnail.png">
    <title>코드덕쿠 커뮤니티</title>
    <meta name="description" content="기타리스트·베이시스트·밴드맨을 위한 커뮤니티. 밴드 구인구직, 개인레슨, 중고악기 거래, 자유게시판.">
    <!-- 검색엔진 최적화 (SEO) -->
    <meta name="robots" content="index, follow">
    <meta name="author" content="COODUCK">
    <meta name="keywords" content="기타 커뮤니티, 밴드 구인, 기타 레슨, 중고악기, 베이스, 밴드맨, 코드덕쿠, 코드덕후, 코덕, Codeducku, 음악커뮤니티, 뮤지션커뮤니티, 쿠슐랭가이드">
    <link rel="canonical" href="https://codeducku.vercel.app/community.html">
    <meta property="og:type" content="website">
    <meta property="og:title" content="코드덕쿠 커뮤니티">
    <meta property="og:description" content="기타리스트·베이시스트·밴드맨을 위한 커뮤니티. 밴드 구인구직, 개인레슨, 중고악기 거래.">
    <meta property="og:image" content="https://www.genspark.ai/api/files/s/EsaPAYLv">
    <meta property="og:locale" content="ko_KR">
    <meta property="og:site_name" content="코드덕쿠 by COODUCK">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="코드덕쿠 커뮤니티">
    <meta name="twitter:description" content="기타리스트·베이시스트·밴드맨을 위한 커뮤니티.">
    <meta name="twitter:image" content="https://www.genspark.ai/api/files/s/EsaPAYLv">
    <!-- Google Search Console 소유권 인증 -->
    <meta name="google-site-verification" content="y_LIOep_Kgw8SPVqt4XB5oCKlfscobw2V2fkQV2J6HM" />
    <!-- Naver Search Advisor 소유권 인증 -->
    <meta name="naver-site-verification" content="72f154aec62c295b28b8f27b077b8c961e862892" />
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="js/ads.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="js/inquiry.js"></script>
    <style>
        /* ── 커뮤니티 전용 스타일 ── */
        .comm-hero {
            background: linear-gradient(135deg, #fff7f0 0%, #fef3c7 50%, #ecfdf5 100%);
            border-bottom: 1px solid var(--border-light);
            padding: 36px 0 28px;
        }
        .comm-hero-inner {
            max-width: 1240px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .comm-hero-icon {
            width: 60px; height: 60px;
            background: linear-gradient(135deg, #e85d04, #f48c06);
            border-radius: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 16px rgba(232,93,4,0.25);
            flex-shrink: 0;
        }
        .comm-hero h1 {
            font-size: 1.7rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .comm-hero p {
            font-size: 0.88rem;
            color: var(--text-secondary);
        }
        .comm-stats {
            margin-left: auto;
            display: flex;
            gap: 20px;
            flex-shrink: 0;
        }
        .comm-stat-item {
            text-align: center;
        }
        .comm-stat-item .num {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--accent);
        }
        .comm-stat-item .lbl {
            font-size: 0.72rem;
            color: var(--text-muted);
        }

        /* ── 메인 레이아웃 ── */
        .comm-layout {
            max-width: 100%;
            margin: 0 auto;
            padding: 28px 24px 60px;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 24px;
        }
        @media (max-width: 860px) {
            .comm-layout { grid-template-columns: 1fr; }
            .comm-sidebar { display: none !important; }
            .comm-main-layout {
                padding: 12px 10px 60px;
                gap: 0;
            }
            .comm-hero-inner {
                flex-wrap: wrap;
                gap: 12px;
                padding: 0 14px;
            }
            .comm-hero h1 { font-size: clamp(1.1rem, 5vw, 1.4rem); word-break: keep-all; }
            .comm-hero p  { font-size: 0.82rem; word-break: keep-all; }
            .comm-stats { margin-left: 0; gap: 12px; flex-wrap: wrap; }
            .comm-stat-item { font-size: 0.8rem; }
            /* 필터/검색바 모바일 */
            .search-bar { flex-wrap: wrap; gap: 8px; padding: 10px 12px; }
            .search-bar input { width: 100%; min-width: 0; font-size: 0.9rem; }
            .search-bar select { flex: 1 1 calc(50% - 4px); min-width: 0; font-size: 0.82rem; }
            .search-bar button { width: 100%; padding: 9px; }
            /* 탭 바 */
            .tab-bar { flex-wrap: wrap; gap: 6px; padding: 10px 12px; }
            .tab-btn  { font-size: 0.78rem; padding: 6px 12px; }
            /* 게시글 카드 */
            .post-card { padding: 12px 14px; }
            .post-title { font-size: 0.9rem; white-space: normal; word-break: keep-all; }
            .post-preview { font-size: 0.78rem; }
            .post-card-top { gap: 8px; }
            /* 글쓰기 버튼 */
            .write-btn { font-size: 0.82rem; padding: 8px 14px; }
            /* 헤더 모바일 */
            .comm-hero { padding: 22px 0 18px; }
        }

        /* ── 사이드바 기본 ── */
        /* grid-area: sidebar 로 오른쪽 열에 배치됨 (아래 레이아웃 CSS 참조) */
        .sidebar-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 10px 8px;
            margin-bottom: 8px;
            box-shadow: var(--shadow);
        }
        .sidebar-section h3 {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin-bottom: 6px;
            padding: 0 5px;
        }
        .sidebar-menu {
            list-style: none;
        }
        .sidebar-menu li a, .sidebar-menu li button {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 7px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            transition: all 0.15s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sidebar-menu li a:hover, .sidebar-menu li button:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .sidebar-menu li a.active, .sidebar-menu li button.active {
            background: #fff7f0;
            color: var(--accent);
            font-weight: 700;
        }
        .sidebar-menu li a .badge, .sidebar-menu li button .badge {
            margin-left: auto;
            background: #fee2e2;
            color: #dc2626;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 1px 7px;
            border-radius: 99px;
        }
        .sidebar-menu li a .badge.blue { background: #dbeafe; color: #2563eb; }
        .sidebar-menu li a .badge.green { background: #dcfce7; color: #16a34a; }
        .sidebar-menu li a .badge.orange { background: #fff7ed; color: #ea580c; }
        .sidebar-menu li button .badge.blue { background: #dbeafe; color: #2563eb; }
        .sidebar-menu li button .badge.green { background: #dcfce7; color: #16a34a; }
        .sidebar-menu li button .badge.orange { background: #fff7ed; color: #ea580c; }

        /* 중고장터 서브메뉴 */
        .used-sub-menu {
            list-style: none;
            padding-left: 8px;
            margin-top: 2px;
            display: none;
        }
        .used-sub-menu.open { display: block; }
        .used-sub-menu li button {
            font-size: 0.82rem !important;
            padding: 5px 10px !important;
            color: var(--text-muted) !important;
        }
        .used-sub-menu li button:hover, .used-sub-menu li button.active {
            color: var(--accent) !important;
            background: #fff7f0 !important;
        }

        /* ── 콘텐츠 영역 ── */
        .comm-content { min-width: 0; }

        /* 탭 + 필터 바 */
        .tab-filter-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
        }
        .category-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .category-title .icon-badge {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem;
        }
        .filter-group {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .filter-select {
            padding: 7px 14px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 0.84rem;
            color: var(--text-secondary);
            background: var(--bg-card);
            cursor: pointer;
            outline: none;
        }
        .filter-select:focus { border-color: var(--accent); }
        .write-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 20px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .write-btn:hover { background: #c24e03; transform: translateY(-1px); }

        /* 검색 바 */
        .search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 14px;
        }
        .search-bar input {
            flex: 1;
            padding: 10px 16px;
            border: 1.5px solid var(--border);
            border-radius: 10px;
            font-size: 0.92rem;
            outline: none;
            color: var(--text-primary);
            background: var(--bg-card);
        }
        .search-bar input:focus { border-color: var(--accent); }
        .search-bar button {
            padding: 10px 18px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 0.88rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* 게시글 목록 */
        .post-list { display: flex; flex-direction: column; gap: 8px; }

        .post-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px 22px;
            cursor: pointer;
            transition: all 0.18s;
            box-shadow: var(--shadow);
        }
        .post-card:hover {
            border-color: #fdba74;
            background: #fffaf7;
            box-shadow: 0 4px 24px rgba(232,93,4,0.12);
            transform: translateY(-1px);
        }

        /* ── 이미지 업로드 드롭존 ── */
        .img-upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            background: #f8fafc;
            cursor: pointer;
            transition: border-color .18s, background .18s;
            overflow: hidden;
            min-height: 100px;
        }
        .img-upload-zone:hover,
        .img-upload-zone.drag-over {
            border-color: var(--accent);
            background: #fff7ed;
        }
        .img-upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 28px 20px;
            user-select: none;
        }
        .img-upload-preview {
            position: relative;
            width: 100%;
        }
        .img-upload-preview img {
            width: 100%;
            max-height: 240px;
            object-fit: contain;
            background: #f1f5f9;
            display: block;
            border-radius: 10px;
        }
        .img-remove-btn {
            position: absolute;
            top: 8px; right: 8px;
            width: 28px; height: 28px;
            border-radius: 50%;
            background: rgba(0,0,0,.55);
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: .8rem;
            display: flex; align-items: center; justify-content: center;
            transition: background .15s;
            z-index: 2;
        }
        .img-remove-btn:hover { background: rgba(220,38,38,.85); }
        .img-upload-info {
            font-size: .72rem;
            color: #64748b;
            padding: 6px 10px 8px;
            text-align: center;
        }
        .img-uploading {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 18px 20px;
            font-size: .85rem;
            color: var(--accent);
            font-weight: 600;
        }
        .img-uploading .fa-spinner { animation: spin .8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ── 게시글 카드 공통 사진 썸네일 ── */
        .post-card-thumb {
            flex-shrink: 0;
            width: 72px;
            height: 72px;
            border-radius: 8px;
            overflow: hidden;
            border: 1.5px solid #e2e8f0;
            background: #f8fafc;
            order: 10; /* 맨 오른쪽 */
        }
        .post-card-thumb img {
            width: 100%; height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 0.2s;
        }
        .post-card:hover .post-card-thumb img { transform: scale(1.06); }

        /* 레슨 카드 사진 */
        .lesson-card-thumb {
            width: 100%; height: 160px;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            border-bottom: 1.5px solid #e2e8f0;
            background: #f8fafc;
            margin: -16px -16px 12px;
            width: calc(100% + 32px);
        }
        .lesson-card-thumb img {
            width: 100%; height: 100%;
            object-fit: cover; display: block;
        }

        /* 밴드구인 카드 사진 */
        .recruit-card-thumb {
            width: 100%; height: 150px;
            overflow: hidden;
            border-radius: 10px;
            border: 1.5px solid #e2e8f0;
            background: #f8fafc;
            margin-bottom: 12px;
        }
        .recruit-card-thumb img {
            width: 100%; height: 100%;
            object-fit: cover; display: block;
        }
        .post-card-top {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .post-category-badge {
            flex-shrink: 0;
            padding: 3px 9px;
            border-radius: 6px;
            font-size: 0.72rem;
            font-weight: 700;
            margin-top: 2px;
        }
        .badge-band { background: #fee2e2; color: #dc2626; }
        .badge-lesson { background: #dbeafe; color: #2563eb; }
        .badge-used { background: #dcfce7; color: #16a34a; }
        .badge-talk { background: #fef9c3; color: #ca8a04; }
        .badge-info { background: #f3e8ff; color: #9333ea; }

        .post-title-area { flex: 1; min-width: 0; }
        .post-title {
            font-size: 1.03rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
        }
        .post-preview {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
        }
        .post-price {
            flex-shrink: 0;
            font-size: 1.05rem;
            font-weight: 800;
            color: #16a34a;
            margin-left: auto;
            padding-left: 12px;
        }
        .post-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 10px;
            font-size: 0.82rem;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
            padding-top: 8px;
        }
        .post-meta span { display: flex; align-items: center; gap: 4px; }
        .post-meta .meta-views { color: #2563eb; font-weight: 600; }
        .post-meta .meta-date { margin-left: auto; color: var(--text-muted); }
        .post-tags {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .tag {
            padding: 2px 8px;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-size: 0.72rem;
            color: var(--text-secondary);
        }

        /* ── 중고장터 카드 그리드 ── */
        .gear-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }
        .gear-card {
            background: var(--bg-card);
            border: 1.5px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.18s;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }
        .gear-card:hover {
            border-color: #4ade80;
            box-shadow: 0 8px 28px rgba(22,163,74,0.15);
            transform: translateY(-3px);
        }
        .gear-card--sold { opacity: 0.72; }

        /* 사진 있을 때 */
        .gear-card-photo {
            position: relative;
            width: 100%;
            height: 180px;
            overflow: hidden;
            background: #f1f5f9;
            flex-shrink: 0;
        }
        .gear-card-photo img {
            width: 100%; height: 100%;
            object-fit: cover;
            transition: transform 0.25s;
        }
        .gear-card:hover .gear-card-photo img { transform: scale(1.04); }

        /* 사진 없을 때 */
        .gear-card-noimg-wrap {
            position: relative;
            width: 100%; height: 140px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .gear-card-noimg-icon { font-size: 3.6rem; opacity: 0.55; }

        /* 상태 뱃지 */
        .gear-status-badge {
            position: absolute;
            top: 10px; right: 10px;
            padding: 3px 9px;
            border-radius: 6px;
            font-size: 0.72rem;
            font-weight: 700;
            backdrop-filter: blur(4px);
        }
        .status-active { background: rgba(220,252,231,.9); color: #15803d; border: 1px solid #86efac; }
        .status-sold   { background: rgba(241,245,249,.9); color: #64748b; border: 1px solid #cbd5e1; }

        /* 카드 바디 */
        .gear-card-body { padding: 13px 14px 14px; display: flex; flex-direction: column; gap: 5px; flex: 1; }
        .gear-card-sub-row { display: flex; align-items: center; justify-content: space-between; }
        .gear-card-sub-badge {
            font-size: 0.68rem; font-weight: 700;
            padding: 2px 8px; border-radius: 20px;
            background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0;
        }
        .gear-card-date { font-size: 0.7rem; color: var(--text-muted); }
        .gear-card-title {
            font-size: 0.92rem; font-weight: 700;
            color: var(--text-primary);
            overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            line-height: 1.4;
        }
        .gear-card-location {
            font-size: 0.74rem; color: var(--text-muted);
            min-height: 1em;
        }
        .gear-card-location i { margin-right: 3px; }
        .gear-card-price-row {
            display: flex; align-items: center;
            justify-content: space-between; gap: 8px;
            margin-top: 4px;
        }
        .gear-card-price {
            font-size: 1.05rem; font-weight: 800;
            color: #16a34a;
        }
        .gear-card-contact-chip {
            font-size: 0.68rem; font-weight: 700;
            padding: 2px 8px; border-radius: 20px;
            background: #eff6ff; color: #1d4ed8;
            border: 1px solid #bfdbfe;
            white-space: nowrap;
        }
        .gear-card-meta {
            display: flex; gap: 10px; align-items: center;
            margin-top: 4px;
            font-size: 0.74rem; color: var(--text-muted);
            border-top: 1px solid #f1f5f9;
            padding-top: 8px;
        }

        /* ── 상세 모달: 상품 이미지 ── */
        .detail-product-img {
            width: 100%; max-height: 320px;
            border-radius: 12px; overflow: hidden;
            margin-bottom: 14px;
            border: 1.5px solid #e2e8f0;
        }
        .detail-product-img img {
            width: 100%; max-height: 320px;
            object-fit: contain;
            background: #f8fafc;
            display: block;
        }
        .detail-contact {
            display: flex; align-items: center; gap: 10px;
            background: #eff6ff;
            border: 1.5px solid #bfdbfe;
            border-radius: 10px;
            padding: 12px 16px;
            margin-top: 14px;
            font-size: 0.87rem;
        }
        .detail-contact strong { color: #1d4ed8; white-space: nowrap; }
        .detail-contact-value {
            font-weight: 700; color: #1e40af;
            font-size: 0.95rem; letter-spacing: 0.02em;
        }

        /* 레슨 카드 */
        .lesson-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 14px;
        }
        .lesson-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px;
            cursor: pointer;
            transition: all 0.18s;
            box-shadow: var(--shadow);
        }
        .lesson-card:hover {
            border-color: #93c5fd;
            box-shadow: 0 6px 24px rgba(37,99,235,0.10);
            transform: translateY(-2px);
        }
        .lesson-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .lesson-avatar {
            width: 46px; height: 46px;
            border-radius: 12px;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .lesson-card-title {
            font-size: 0.93rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 3px;
        }
        .lesson-card-author {
            font-size: 0.78rem;
            color: var(--text-muted);
        }
        .lesson-card-desc {
            font-size: 0.82rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .lesson-price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .lesson-price {
            font-size: 1.05rem;
            font-weight: 800;
            color: #2563eb;
        }
        .lesson-badge {
            padding: 3px 8px;
            background: #eff6ff;
            color: #2563eb;
            border-radius: 6px;
            font-size: 0.72rem;
            font-weight: 600;
        }

        /* 구인구직 카드 */
        .recruit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 14px;
        }
        .recruit-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px;
            cursor: pointer;
            transition: all 0.18s;
            box-shadow: var(--shadow);
        }
        .recruit-card:hover {
            border-color: #fca5a5;
            box-shadow: 0 6px 24px rgba(220,38,38,0.08);
            transform: translateY(-2px);
        }
        .recruit-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .recruit-icon {
            width: 42px; height: 42px;
            border-radius: 10px;
            background: linear-gradient(135deg, #fff1f2, #ffe4e6);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
        }
        .recruit-title {
            font-size: 0.93rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        .recruit-author { font-size: 0.76rem; color: var(--text-muted); }
        .recruit-body {
            font-size: 0.83rem;
            color: var(--text-secondary);
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .recruit-footer {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .recruit-tag {
            padding: 3px 8px;
            background: #fff1f2;
            color: #dc2626;
            border-radius: 6px;
            font-size: 0.72rem;
            font-weight: 600;
        }
        .recruit-location {
            padding: 3px 8px;
            background: var(--bg-secondary);
            color: var(--text-muted);
            border-radius: 6px;
            font-size: 0.72rem;
        }

        /* 빈 목록 안내 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        .empty-state .empty-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.4; }
        .empty-state p { font-size: 0.9rem; }

        /* 페이지네이션 */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 24px;
        }
        .page-btn {
            width: 34px; height: 34px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.15s;
        }
        .page-btn:hover { border-color: var(--accent); color: var(--accent); }
        .page-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; font-weight: 700; }

        /* 글쓰기 모달 */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }
        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 32px 36px;
            width: 100%;
            max-width: 860px;
            max-height: 88vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.22);
            transform: translateY(10px);
            transition: transform 0.2s;
        }
        .modal-overlay.open .modal { transform: translateY(0); }
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .modal-header h2 { font-size: 1.1rem; font-weight: 800; color: var(--text-primary); }
        .modal-close {
            width: 32px; height: 32px;
            border: none;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-muted);
            display: flex; align-items: center; justify-content: center;
        }
        .modal-close:hover { background: #fee2e2; color: #dc2626; }
        .form-group { margin-bottom: 14px; }
        .form-group label {
            display: block;
            font-size: 0.83rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 9px 12px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 0.88rem;
            color: var(--text-primary);
            background: var(--bg-card);
            outline: none;
            transition: border-color 0.15s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--accent);
        }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .btn-cancel {
            padding: 9px 18px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.88rem;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-submit {
            padding: 9px 22px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 0.88rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-submit:hover { background: #c24e03; }

        /* 게시글 상세 모달 */
        .detail-modal {
            max-width: 920px;
            padding: 36px 40px;
        }
        .detail-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .detail-meta {
            display: flex;
            gap: 14px;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
        }
        .detail-meta span { display: flex; align-items: center; gap: 4px; }
        .detail-body {
            font-size: 0.97rem;
            color: var(--text-secondary);
            line-height: 1.85;
            margin-bottom: 20px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .detail-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; }
        .detail-price-box {
            padding: 12px 16px;
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 10px;
            margin-bottom: 14px;
        }
        .detail-price-box .price-lbl { font-size: 0.8rem; color: #16a34a; font-weight: 600; margin-bottom: 4px; }
        .detail-price-box .price-val { font-size: 1.3rem; font-weight: 800; color: #15803d; }

        /* 모달 모바일 대응 */
        @media (max-width: 768px) {
            .modal {
                padding: 22px 18px;
                max-height: 92vh;
                border-radius: 16px;
            }
            .detail-modal {
                padding: 22px 18px;
            }
            .detail-title { font-size: 1.1rem; }
            .detail-body  { font-size: 0.9rem; }
        }

        /* 토스트 */
        .toast {
            position: fixed;
            bottom: 28px; right: 28px;
            padding: 12px 20px;
            background: #1e2433;
            color: #fff;
            border-radius: 12px;
            font-size: 0.88rem;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            z-index: 9999;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s;
            pointer-events: none;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* 로딩 스피너 */
        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--text-muted);
            gap: 10px;
        }
        .spinner {
            width: 22px; height: 22px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* 안내 배너 */
        .mule-tip-banner {
            background: linear-gradient(90deg, #fffbeb, #fff7f0);
            border: 1.5px solid #fed7aa;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 18px;
            font-size: 0.82rem;
            color: #92400e;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .mule-tip-banner .tip-icon { font-size: 1.1rem; flex-shrink: 0; margin-top: 1px; }

        /* ── 댓글 영역 ── */
        .comment-section {
            margin-top: 20px;
            padding-top: 18px;
            border-top: 1.5px solid var(--border-light);
        }
        .comment-section-title {
            font-size: 0.92rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 7px;
            margin-bottom: 16px;
        }
        .comment-count-badge {
            background: #e85d04;
            color: #fff;
            font-size: 0.72rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 99px;
            min-width: 22px;
            text-align: center;
        }

        /* 댓글 작성 폼 */
        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
            background: #f8fafc;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            padding: 14px;
        }
        .comment-form-row {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }
        .comment-author-input {
            width: 130px;
            flex-shrink: 0;
            padding: 8px 11px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 0.84rem;
            color: var(--text-primary);
            background: #fff;
            outline: none;
        }
        .comment-author-input:focus { border-color: var(--accent); }
        .comment-textarea {
            flex: 1;
            padding: 8px 11px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 0.84rem;
            color: var(--text-primary);
            background: #fff;
            resize: none;
            min-height: 64px;
            outline: none;
            font-family: inherit;
            line-height: 1.5;
        }
        .comment-textarea:focus { border-color: var(--accent); }
        .comment-submit-btn {
            align-self: flex-end;
            padding: 8px 18px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 0.84rem;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.15s;
        }
        .comment-submit-btn:hover { background: #c24e03; }
        .comment-submit-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* 댓글 목록 */
        .comment-list { display: flex; flex-direction: column; gap: 2px; }

        /* 개별 댓글 */
        .comment-item {
            padding: 12px 14px;
            border-radius: 10px;
            background: #fff;
            border: 1px solid var(--border-light);
            transition: background 0.15s;
        }
        .comment-item:hover { background: #fafbff; }
        .comment-item.is-reply {
            margin-left: 32px;
            background: #f8fafc;
            border-left: 3px solid #e0e7ff;
        }
        .comment-item.is-reply:hover { background: #f0f4ff; }
        .comment-item.is-deleted .comment-body {
            color: var(--text-muted);
            font-style: italic;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .comment-avatar {
            width: 28px; height: 28px;
            border-radius: 8px;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
            color: #92400e;
            flex-shrink: 0;
        }
        .comment-item.is-reply .comment-avatar {
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            color: #3730a3;
        }
        .comment-author-name {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .comment-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: 2px;
        }
        .comment-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .comment-action-btn {
            padding: 3px 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: transparent;
            font-size: 0.72rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
            display: flex; align-items: center; gap: 3px;
        }
        .comment-action-btn:hover { border-color: var(--accent); color: var(--accent); }
        .comment-action-btn.like-active { border-color: #e85d04; color: #e85d04; background: #fff7f0; }
        .comment-action-btn.delete-btn:hover { border-color: #dc2626; color: #dc2626; background: #fff1f2; }

        .comment-body {
            font-size: 0.87rem;
            color: var(--text-secondary);
            line-height: 1.65;
            word-break: break-word;
            padding-left: 36px;
        }

        /* 대댓글 작성 폼 (인라인 토글) */
        .reply-form-wrap {
            margin-top: 8px;
            padding-left: 36px;
            display: none;
        }
        .reply-form-wrap.open { display: block; }
        .reply-form {
            display: flex;
            gap: 6px;
            align-items: flex-start;
            background: #f0f4ff;
            border: 1.5px solid #c7d2fe;
            border-radius: 10px;
            padding: 10px;
        }
        .reply-textarea {
            flex: 1;
            padding: 7px 10px;
            border: 1.5px solid #c7d2fe;
            border-radius: 7px;
            font-size: 0.82rem;
            color: var(--text-primary);
            background: #fff;
            resize: none;
            min-height: 52px;
            outline: none;
            font-family: inherit;
        }
        .reply-textarea:focus { border-color: #6366f1; }
        .reply-author-input {
            width: 110px;
            flex-shrink: 0;
            padding: 7px 10px;
            border: 1.5px solid #c7d2fe;
            border-radius: 7px;
            font-size: 0.82rem;
            background: #fff;
            outline: none;
        }
        .reply-author-input:focus { border-color: #6366f1; }
        .reply-btns {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .reply-submit-btn {
            padding: 6px 14px;
            background: #6366f1;
            color: #fff;
            border: none;
            border-radius: 7px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.15s;
        }
        .reply-submit-btn:hover { background: #4f46e5; }
        .reply-cancel-btn {
            padding: 6px 14px;
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
            border-radius: 7px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .reply-cancel-btn:hover { background: var(--bg-secondary); }

        /* 댓글 로딩/빈 상태 */
        .comment-empty {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        .comment-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.84rem;
        }
        .comment-spinner {
            width: 16px; height: 16px;
            border: 2.5px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            flex-shrink: 0;
        }

        /* 게시글 카드 댓글 수 뱃지 */
        .comment-cnt {
            display: flex; align-items: center; gap: 3px;
            color: var(--text-muted);
            font-size: 0.78rem;
        }
        .comment-cnt i { font-size: 0.72rem; }

        /* ── 커뮤니티 메인 레이아웃 ── */
        .comm-main-layout {
            max-width: 1240px;
            margin: 0 auto;
            padding: 20px 20px 60px;
        }
        /* 중앙 콘텐츠 래퍼 ── 사이드바(왼) + 게시물(오) */
        .comm-center-wrapper {
            display: grid !important;
            grid-template-columns: 200px minmax(0,1fr) !important;
            grid-template-areas: "sidebar content" !important;
            gap: 16px;
            min-width: 0;
            align-items: start;
        }
        /* 게시물: 오른쪽 두 번째 열 */
        .comm-content {
            grid-area: content;
            min-width: 0;
        }
        /* 사이드바: 왼쪽 첫 번째 열 */
        .comm-sidebar {
            grid-area: sidebar;
            position: sticky;
            top: 80px;
            align-self: start;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            scrollbar-width: none;
            min-width: 0;
        }
        .comm-sidebar::-webkit-scrollbar { display: none; }
        .comm-sidebar .sidebar-section { word-break: keep-all; }
        .comm-sidebar .sidebar-menu li button {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* 검색바 */
        .search-bar input { font-size: 0.85rem; }
        /* 상단 툴바 */
        .board-toolbar { flex-wrap: wrap; gap: 8px; }
        @media (max-width: 860px) {
            .comm-center-wrapper {
                grid-template-columns: 1fr !important;
                grid-template-areas: "content" !important;
            }
            .comm-sidebar { display: none !important; }
        }
        /* ── 홈 FAB 버튼 ── */
        .home-fab{position:fixed;bottom:26px;left:26px;width:48px;height:48px;background:#d45d00;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;text-decoration:none;box-shadow:0 4px 16px rgba(212,93,0,.38);z-index:800;transition:background .18s,transform .18s;}
        .home-fab:hover{background:#b84e00;transform:scale(1.1);}
        .home-fab-tooltip{position:absolute;left:56px;top:50%;transform:translateY(-50%);background:#1e2433;color:#fff;font-size:.74rem;font-weight:700;padding:4px 11px;border-radius:8px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .18s;}
        .home-fab:hover .home-fab-tooltip{opacity:1;}

        /* ── 헤더 Auth 버튼 ── */
        .header-auth-btns {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }
        .nav-btn--login {
            background: #fff7f0 !important;
            color: #e85d04 !important;
            border: 1.5px solid #fdba74 !important;
            font-weight: 700;
            padding: 7px 14px;
            border-radius: 8px;
            font-size: 0.84rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background .18s;
        }
        .nav-btn--login:hover { background: #fff0e0 !important; }
        .nav-btn--logout {
            background: #f3f4f6 !important;
            color: #6b7280 !important;
            border: 1.5px solid #e5e7eb !important;
            font-weight: 600;
            padding: 7px 14px;
            border-radius: 8px;
            font-size: 0.84rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-family: inherit;
            transition: background .18s;
        }
        .nav-btn--logout:hover { background: #e5e7eb !important; }
        .header-profile-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.88rem;
            font-weight: 700;
            color: #e85d04;
            padding: 6px 10px;
            background: #fff7f0;
            border-radius: 8px;
            border: 1.5px solid #fdba74;
        }
        @media (max-width: 900px) {
            .header-auth-btns { display: none; }
        }
        .mobile-auth-area {
            border-top: 1px solid #e5e7eb;
            margin-top: 4px;
            padding-top: 4px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-inner">
            <!-- 상단줄: 로고 + 로그인 박스 -->
            <div class="header-top-row">
                <a href="index.html" class="logo" aria-label="코드덕쿠 홈으로 이동">
                    <i class="fas fa-guitar"></i>
                    <div class="logo-textbox">
                        <span class="logo-text">Code<span class="accent">ducku</span></span>
                        <span class="logo-ko">코드덕쿠</span>
                    </div>
                </a>
                <div class="header-login-box">
                    <div class="header-auth-btns" id="headerAuthArea">
                        <a href="login.html" class="nav-btn nav-btn--login" id="headerLoginBtn">
                            <i class="fas fa-sign-in-alt"></i> 로그인
                        </a>
                        <a href="profile.html" class="header-profile-btn" id="headerProfileBtn" style="display:none" title="프로필 수정">
                            <i class="fas fa-user-circle"></i>
                            <span id="headerNickname">닉네임</span>
                        </a>
                        <button class="nav-btn nav-btn--logout" id="headerLogoutBtn" style="display:none" onclick="doLogout()">
                            <i class="fas fa-sign-out-alt"></i> 로그아웃
                        </button>
                    </div>
                </div>
                <button class="hamburger-btn" id="hamburgerBtn" aria-label="메뉴 열기">
                    <span></span><span></span><span></span>
                </button>
            </div>
            <!-- 하단줄: 챕터 네비게이션 -->
            <nav class="header-nav" id="headerNav">
                <div class="header-nav-row1">
                    <div class="nav-info-group">
                        <a href="rehearsal.html" class="nav-btn"><i class="fas fa-music"></i> 합주실</a>
                        <a href="repair.html" class="nav-btn"><i class="fas fa-tools"></i> 리페어샵</a>
                        <a href="instrument.html" class="nav-btn"><i class="fas fa-guitar"></i> 악기샵</a>
                        <a href="academy.html" class="nav-btn"><i class="fas fa-school"></i> 음악학원</a>
                        <a href="venue.html" class="nav-btn"><i class="fas fa-theater-masks"></i> 공연장</a>
                    </div>
                    <div class="nav-service-group">
                        <a href="score.html" class="nav-btn"><i class="fas fa-file-pdf"></i> 악보공유</a>
                        <a href="analyze.html" class="nav-btn"><i class="fas fa-waveform-path"></i> 음원분석</a>
                    </div>
                </div>
                <div class="header-nav-row2">
                    <div class="nav-community-group">
                        <a href="community.html" class="nav-btn" id="navCatAll"><i class="fas fa-home"></i> 전체글</a>
                        <a href="community.html?cat=free" class="nav-btn" id="navCatFree"><i class="fas fa-comment-dots"></i> 자유게시판</a>
                        <a href="community.html?cat=gear" class="nav-btn" id="navCatGear"><i class="fas fa-sliders-h"></i> 장비리뷰</a>
                        <a href="community.html?cat=band" class="nav-btn" id="navCatBand"><i class="fas fa-user-friends"></i> 밴드구인구직</a>
                        <a href="community.html?cat=lesson" class="nav-btn" id="navCatLesson"><i class="fas fa-chalkboard-teacher"></i> 개인레슨</a>
                        <a href="community.html?cat=market" class="nav-btn" id="navCatMarket"><i class="fas fa-tag"></i> 중고장터</a>
                    </div>
                    <div class="nav-video-group">
                        <a href="video-review.html" class="nav-btn"><i class="fas fa-star"></i> 리뷰영상</a>
                        <a href="video-cover.html" class="nav-btn"><i class="fas fa-music"></i> 카피영상</a>
                        <a href="video-fun.html" class="nav-btn"><i class="fas fa-laugh"></i> 재미있는영상</a>
                        <a href="video-bandstage.html" class="nav-btn"><i class="fas fa-drum"></i> 밴드라이브</a>
                    </div>
                </div>
            </nav>
        </div>
        <div class="mobile-menu" id="mobileMenu">
            <div style="padding:5px 12px 2px;font-size:.68rem;font-weight:800;color:#059669;letter-spacing:.04em;">📍 정보</div>
            <a href="rehearsal.html" class="mobile-menu-item"><i class="fas fa-music" style="color:#0369a1"></i> 합주실 찾기</a>
            <a href="repair.html" class="mobile-menu-item"><i class="fas fa-tools" style="color:#7c3aed"></i> 리페어샵 찾기</a>
            <a href="instrument.html" class="mobile-menu-item"><i class="fas fa-guitar" style="color:#0f766e"></i> 악기샵 찾기</a>
            <a href="academy.html" class="mobile-menu-item"><i class="fas fa-school" style="color:#d45d00"></i> 음악학원 찾기</a>
            <a href="venue.html" class="mobile-menu-item"><i class="fas fa-theater-masks" style="color:#7c3aed"></i> 공연장 찾기</a>
            <div style="border-top:1px solid #e5e7eb;margin:4px 0;"></div>
            <div style="padding:4px 12px 2px;font-size:.68rem;font-weight:800;color:#7c3aed;letter-spacing:.04em;">🎵 코덕서비스</div>
            <a href="score.html" class="mobile-menu-item"><i class="fas fa-file-pdf" style="color:#6d28d9"></i> 악보공유</a>
            <a href="analyze.html" class="mobile-menu-item"><i class="fas fa-waveform-path" style="color:#7c3aed"></i> 음원분석</a>
            <div style="border-top:1px solid #e5e7eb;margin:4px 0;"></div>
            <div style="padding:4px 12px 2px;font-size:.68rem;font-weight:800;color:#ea580c;letter-spacing:.04em;">💬 커뮤니티</div>
            <a href="community.html" class="mobile-menu-item"><i class="fas fa-comment-dots" style="color:#f97316"></i> 자유게시판</a>
            <a href="community.html?cat=gear" class="mobile-menu-item"><i class="fas fa-sliders-h" style="color:#f97316"></i> 장비리뷰/정보</a>
            <a href="community.html?cat=band" class="mobile-menu-item"><i class="fas fa-user-friends" style="color:#f97316"></i> 밴드구인구직</a>
            <a href="community.html?cat=lesson" class="mobile-menu-item"><i class="fas fa-chalkboard-teacher" style="color:#f97316"></i> 개인레슨</a>
            <a href="community.html?cat=market" class="mobile-menu-item"><i class="fas fa-tag" style="color:#f97316"></i> 중고장터</a>
            <div style="border-top:1px solid #e5e7eb;margin:4px 0;"></div>
            <div style="padding:4px 12px 2px;font-size:.68rem;font-weight:800;color:#dc2626;letter-spacing:.04em;">🎬 영상</div>
            <a href="video-review.html" class="mobile-menu-item"><i class="fas fa-star" style="color:#dc2626"></i> 리뷰영상</a>
            <a href="video-cover.html" class="mobile-menu-item"><i class="fas fa-music" style="color:#dc2626"></i> 카피영상</a>
            <a href="video-fun.html" class="mobile-menu-item"><i class="fas fa-laugh" style="color:#dc2626"></i> 재미있는영상</a>
            <a href="video-bandstage.html" class="mobile-menu-item"><i class="fas fa-drum" style="color:#dc2626"></i> 밴드라이브</a>
            <div class="mobile-auth-area" id="mobileAuthArea">
                <a href="login.html" class="mobile-menu-item" id="mobileLoginBtn">
                    <i class="fas fa-sign-in-alt"></i> 로그인 / 회원가입
                </a>
                <button class="mobile-menu-item" id="mobileLogoutBtn" style="display:none; background:none; border:none; width:100%; text-align:left; cursor:pointer;" onclick="doLogout()">
                    <i class="fas fa-sign-out-alt"></i> 로그아웃
                </button>
            </div>
        </div>
    </header>
    </header>

    <!-- 커뮤니티 히어로 -->
    <div class="comm-hero">
        <div class="comm-hero-inner">
            <div class="comm-hero-icon">🎸</div>
            <div>
                <h1>뮤지션 커뮤니티</h1>
                <p>밴드 구인구직 · 개인레슨 · 중고악기거래 · 자유게시판</p>
            </div>
            <div class="comm-stats">
                <div class="comm-stat-item">
                    <div class="num" id="totalPosts">-</div>
                    <div class="lbl">전체 게시글</div>
                </div>
                <div class="comm-stat-item">
                    <div class="num" id="todayPosts">3</div>
                    <div class="lbl">오늘 등록</div>
                </div>
                <div class="comm-stat-item">
                    <div class="num">🟢</div>
                    <div class="lbl">활성</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 메인 레이아웃 -->
    <div class="comm-main-layout">
        <!-- 사이드바 + 콘텐츠 래퍼 -->
        <div class="comm-center-wrapper">
        <!-- 게시물 콘텐츠 (왼쪽) -->
        <main class="comm-content">
            <!-- 안내 배너 -->
            <div class="mule-tip-banner">
                <span class="tip-icon">💡</span>
                <div>
                    <strong style="display:inline;font-weight:700;">뮤지션 커뮤니티 베타 오픈!</strong>
                    &nbsp;밴드 구인구직, 개인레슨 매칭, 중고악기 거래까지! 게시글을 등록해보세요 🎸
                </div>
            </div>

            <!-- 상단 필터 바 -->
            <div class="tab-filter-bar">
                <div class="category-title" id="categoryTitle">
                    <span class="icon-badge" style="background:#fff7f0;">🏠</span>
                    전체글 보기
                </div>
                <div class="filter-group">
                    <select class="filter-select" id="sortSelect">
                        <option value="latest">최신순</option>
                        <option value="views">조회수순</option>
                        <option value="likes">좋아요순</option>
                    </select>
                    <button class="write-btn" id="writeBtn">
                        <i class="fas fa-pen"></i> 글쓰기
                    </button>
                </div>
            </div>

            <!-- 검색 바 -->
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="제목, 내용, 작성자 검색..." />
                <button id="searchBtn"><i class="fas fa-search"></i></button>
            </div>

            <!-- 게시글 목록 -->
            <div id="postContainer">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <span>불러오는 중...</span>
                </div>
            </div>

            <!-- 페이지네이션 -->
            <div class="pagination" id="pagination"></div>
        </main>

        <!-- 사이드바 메뉴 (오른쪽) -->
        <aside class="comm-sidebar">
            <div class="sidebar-section">
                <h3>전체 메뉴</h3>
                <ul class="sidebar-menu" id="sideMenu">
                    <li><button data-cat="all" class="active"><i class="fas fa-home" style="width:16px;color:#e85d04"></i> 전체글 보기</button></li>
                    <li><button data-cat="free_talk"><i class="fas fa-comment-dots" style="width:16px;color:#ca8a04"></i> 자유게시판</button></li>
                    <li><button data-cat="info"><i class="fas fa-star" style="width:16px;color:#9333ea"></i> 장비리뷰 / 정보</button></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>🎸 밴드 구인구직</h3>
                <ul class="sidebar-menu">
                    <li><button data-cat="band_recruit" data-sub="all"><i class="fas fa-users" style="width:16px;color:#dc2626"></i> 전체 구인구직</button></li>
                    <li><button data-cat="band_recruit" data-sub="guitarist"><i class="fas fa-guitar" style="width:16px;color:#dc2626"></i> 기타리스트 모집</button></li>
                    <li><button data-cat="band_recruit" data-sub="bassist"><i class="fas fa-music" style="width:16px;color:#dc2626"></i> 베이시스트 모집</button></li>
                    <li><button data-cat="band_recruit" data-sub="drummer"><i class="fas fa-drum" style="width:16px;color:#dc2626"></i> 드러머 모집</button></li>
                    <li><button data-cat="band_recruit" data-sub="vocalist"><i class="fas fa-microphone" style="width:16px;color:#dc2626"></i> 보컬리스트 모집</button></li>
                    <li><button data-cat="band_recruit" data-sub="band_join"><i class="fas fa-user-plus" style="width:16px;color:#dc2626"></i> 밴드 찾습니다</button></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>🎓 개인 레슨</h3>
                <ul class="sidebar-menu">
                    <li><button data-cat="lesson" data-sub="all"><i class="fas fa-chalkboard-teacher" style="width:16px;color:#2563eb"></i> 전체 레슨</button></li>
                    <li><button data-cat="lesson" data-sub="guitar"><i class="fas fa-guitar" style="width:16px;color:#2563eb"></i> 기타 레슨</button></li>
                    <li><button data-cat="lesson" data-sub="bass"><i class="fas fa-music" style="width:16px;color:#2563eb"></i> 베이스 레슨</button></li>
                    <li><button data-cat="lesson" data-sub="drum"><i class="fas fa-drum" style="width:16px;color:#2563eb"></i> 드럼 레슨</button></li>
                    <li><button data-cat="lesson" data-sub="vocal"><i class="fas fa-microphone-alt" style="width:16px;color:#2563eb"></i> 보컬 레슨</button></li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>🛒 중고장터</h3>
                <ul class="sidebar-menu">
                    <li><button data-cat="used_gear" data-sub="all" id="usedAllBtn"><i class="fas fa-shopping-bag" style="width:16px;color:#16a34a"></i> 전체 중고장터</button></li>
                    <li><button data-cat="used_gear" data-sub="acoustic"><i class="fas fa-guitar" style="width:16px;color:#16a34a"></i> 어쿠스틱 기타</button></li>
                    <li><button data-cat="used_gear" data-sub="electric"><i class="fas fa-bolt" style="width:16px;color:#16a34a"></i> 일렉 기타</button></li>
                    <li><button data-cat="used_gear" data-sub="bass"><i class="fas fa-music" style="width:16px;color:#16a34a"></i> 베이스 기타</button></li>
                    <li><button data-cat="used_gear" data-sub="effector"><i class="fas fa-sliders-h" style="width:16px;color:#16a34a"></i> 이펙터</button></li>
                    <li><button data-cat="used_gear" data-sub="drum"><i class="fas fa-drum" style="width:16px;color:#16a34a"></i> 드럼</button></li>
                    <li><button data-cat="used_gear" data-sub="pa"><i class="fas fa-volume-up" style="width:16px;color:#16a34a"></i> PA / 음향</button></li>
                    <li><button data-cat="used_gear" data-sub="amp"><i class="fas fa-plug" style="width:16px;color:#16a34a"></i> 앰프</button></li>
                    <li><button data-cat="used_gear" data-sub="etc"><i class="fas fa-ellipsis-h" style="width:16px;color:#16a34a"></i> 기타 용품</button></li>
                </ul>
            </div>
        </aside>

        </div><!-- /comm-center-wrapper -->
    </div>

    <!-- 글쓰기 모달 -->
    <div class="modal-overlay" id="writeModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-pen" style="color:var(--accent);margin-right:8px;"></i>게시글 작성</h2>
                <button class="modal-close" id="closeWriteModal">✕</button>
            </div>
            <div class="form-group">
                <label>카테고리 *</label>
                <select id="formCategory">
                    <option value="">카테고리 선택</option>
                    <option value="band_recruit">🎸 밴드 구인구직</option>
                    <option value="lesson">🎓 개인 레슨</option>
                    <option value="used_gear">🛒 중고장터</option>
                    <option value="free_talk">💬 자유게시판</option>
                    <option value="info">⭐ 장비리뷰 / 정보</option>
                </select>
            </div>
            <div class="form-group" id="subCatGroup" style="display:none;">
                <label>세부 카테고리</label>
                <select id="formSubcategory"></select>
            </div>
            <div class="form-group">
                <label>제목 *</label>
                <input type="text" id="formTitle" placeholder="제목을 입력하세요" />
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>작성자 닉네임 *</label>
                    <input type="text" id="formAuthor" placeholder="닉네임" />
                </div>
                <div class="form-group">
                    <label>지역</label>
                    <input type="text" id="formLocation" placeholder="서울 강남구" />
                </div>
            </div>
            <div class="form-group" id="imageUrlGroup">
                <label>
                    사진 첨부 <span style="color:#9ca3af;font-weight:500;font-size:.78rem;">(선택 · JPG/PNG/GIF/WebP · 최대 5MB)</span>
                </label>
                <!-- 업로드 드롭존 -->
                <div class="img-upload-zone" id="imgUploadZone">
                    <input type="file" id="formImageFile" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" hidden>
                    <div class="img-upload-placeholder" id="imgUploadPlaceholder">
                        <i class="fas fa-image" style="font-size:2rem;color:#cbd5e1;display:block;margin-bottom:8px;"></i>
                        <span style="font-size:.85rem;color:#64748b;font-weight:600;">클릭하거나 이미지를 끌어다 놓으세요</span>
                        <span style="font-size:.74rem;color:#9ca3af;margin-top:4px;display:block;">JPG · PNG · GIF · WebP · 최대 5MB</span>
                    </div>
                    <div class="img-upload-preview" id="imgUploadPreview" style="display:none;">
                        <img id="imgPreviewImg" src="" alt="미리보기">
                        <button type="button" class="img-remove-btn" id="imgRemoveBtn" title="사진 제거">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="img-upload-info" id="imgUploadInfo"></div>
                    </div>
                </div>
            </div>
            <div class="form-group" id="priceGroup" style="display:none;">
                <label>판매 가격 (원) <span style="color:#ef4444;">*</span></label>
                <input type="number" id="formPrice" placeholder="예: 150000" min="0" />
            </div>
            <div class="form-group" id="contactGroup" style="display:none;">
                <label>판매자 연락처 <span id="contactRequired"></span></label>
                <input type="text" id="formContact" placeholder="전화번호, 카카오톡 ID, 인스타그램 등" />
            </div>
            <div class="form-group">
                <label>내용 *</label>
                <textarea id="formContent" placeholder="내용을 입력하세요..."></textarea>
            </div>
            <div class="form-group">
                <label>태그 (쉼표로 구분)</label>
                <input type="text" id="formTags" placeholder="기타, 입문자, 서울 ..." />
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="cancelWrite">취소</button>
                <button class="btn-submit" id="submitPost">등록하기</button>
            </div>
        </div>
    </div>

    <!-- 게시글 상세 모달 -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal detail-modal">
            <div class="modal-header">
                <div id="detailCategoryBadge"></div>
                <button class="modal-close" id="closeDetailModal">✕</button>
            </div>
            <!-- 게시글 본문 -->
            <div id="detailContent"></div>

            <!-- ── 댓글 영역 ── -->
            <div class="comment-section">
                <div class="comment-section-title">
                    <i class="fas fa-comments" style="color:var(--accent);"></i>
                    댓글
                    <span class="comment-count-badge" id="commentCountBadge">0</span>
                </div>

                <!-- 댓글 작성 폼 -->
                <div class="comment-form">
                    <div class="comment-form-row">
                        <input type="text" class="comment-author-input" id="newCommentAuthor" placeholder="닉네임" maxlength="20" />
                        <textarea class="comment-textarea" id="newCommentText" placeholder="댓글을 남겨보세요..." maxlength="500" rows="2"></textarea>
                    </div>
                    <div style="display:flex;justify-content:flex-end;gap:8px;align-items:center;">
                        <span id="newCommentCharCount" style="font-size:0.75rem;color:var(--text-muted);">0/500</span>
                        <button class="comment-submit-btn" id="submitCommentBtn">
                            <i class="fas fa-paper-plane"></i> 댓글 등록
                        </button>
                    </div>
                </div>

                <!-- 댓글 목록 -->
                <div id="commentList">
                    <div class="comment-loading">
                        <div class="comment-spinner"></div> 댓글 불러오는 중...
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-cancel" id="closeDetailBtn">닫기</button>
            </div>
        </div>
    </div>

    <!-- 토스트 -->
    <div class="toast" id="toast"></div>

    <!-- 홈 FAB 버튼 -->
    <a href="index.html" id="gw-home-fab" class="home-fab" title="홈으로">
        <i class="fas fa-home"></i>
        <span class="home-fab-tooltip">홈으로</span>
    </a>

    <!-- Supabase JS v2 (Auth) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/auth-header.js"></script>
    <script src="js/supabase.js"></script>
    <script>
    /* ═══════════════════════════════════════════════════
       코드덕쿠 커뮤니티 v2.0 — Supabase 연동
       - 밴드 구인구직 / 개인레슨 / 중고장터 / 자유게시판
       ═══════════════════════════════════════════════════ */
    const API = 'community_posts'; // Supabase 테이블명

    // ── Auth 초기화 ──
    let currentUser = null;
    let currentProfile = null;

    async function initAuth() {
        const session = await getSession();
        if (session) {
            currentUser = session.user;
            currentProfile = await getProfile(currentUser.id);
        }
        updateAuthUI();
    }

    function updateAuthUI() {
        const loginBtn   = document.getElementById('headerLoginBtn');
        const profileBtn = document.getElementById('headerProfileBtn');
        const logoutBtn  = document.getElementById('headerLogoutBtn');
        const nickSpan   = document.getElementById('headerNickname');
        const mobileLogin = document.getElementById('mobileLoginBtn');
        const mobileLogout = document.getElementById('mobileLogoutBtn');

        if (currentUser) {
            const nick = currentProfile?.nickname || currentUser.email.split('@')[0];
            if (loginBtn)   loginBtn.style.display   = 'none';
            if (profileBtn) { profileBtn.style.display = 'inline-flex'; nickSpan.textContent = nick; }
            if (logoutBtn)  logoutBtn.style.display  = 'inline-flex';
            if (mobileLogin)  mobileLogin.style.display  = 'none';
            if (mobileLogout) mobileLogout.style.display = 'block';
        } else {
            if (loginBtn)   loginBtn.style.display   = 'inline-flex';
            if (profileBtn) profileBtn.style.display = 'none';
            if (logoutBtn)  logoutBtn.style.display  = 'none';
            if (mobileLogin)  mobileLogin.style.display  = 'block';
            if (mobileLogout) mobileLogout.style.display = 'none';
        }
    }

    async function doLogout() {
        await signOut();
        currentUser = null;
        currentProfile = null;
        updateAuthUI();
        showToast('👋 로그아웃 되었습니다.');
    }

    const CATEGORY_INFO = {
        all:        { label: '전체글 보기',       icon: '🏠', badge: 'badge-talk' },
        band_recruit:{ label: '밴드 구인구직',     icon: '🎸', badge: 'badge-band' },
        lesson:     { label: '개인 레슨',         icon: '🎓', badge: 'badge-lesson' },
        used_gear:  { label: '중고장터',           icon: '🛒', badge: 'badge-used' },
        free_talk:  { label: '자유게시판',         icon: '💬', badge: 'badge-talk' },
        info:       { label: '장비리뷰 / 정보',    icon: '⭐', badge: 'badge-info' },
    };

    const SUBCATEGORY_OPTIONS = {
        band_recruit: [
            { value: 'all', label: '전체' },
            { value: 'guitarist', label: '기타리스트 모집' },
            { value: 'bassist', label: '베이시스트 모집' },
            { value: 'drummer', label: '드러머 모집' },
            { value: 'vocalist', label: '보컬리스트 모집' },
            { value: 'keyboardist', label: '키보디스트 모집' },
            { value: 'band_join', label: '밴드 찾습니다' },
        ],
        lesson: [
            { value: 'all', label: '전체' },
            { value: 'guitar', label: '기타 레슨' },
            { value: 'bass', label: '베이스 레슨' },
            { value: 'drum', label: '드럼 레슨' },
            { value: 'vocal', label: '보컬 레슨' },
            { value: 'keyboard', label: '건반 레슨' },
        ],
        used_gear: [
            { value: 'all', label: '전체' },
            { value: 'acoustic', label: '어쿠스틱 기타' },
            { value: 'electric', label: '일렉 기타' },
            { value: 'bass', label: '베이스 기타' },
            { value: 'effector', label: '이펙터' },
            { value: 'drum', label: '드럼' },
            { value: 'pa', label: 'PA / 음향' },
            { value: 'amp', label: '앰프' },
            { value: 'etc', label: '기타 용품' },
        ],
        free_talk: [], info: [],
    };

    const GEAR_ICON = {
        acoustic: '🎸', electric: '⚡', bass: '🎵',
        effector: '🎛️', drum: '🥁', pa: '🔊', amp: '🔌', etc: '🎼'
    };

    // ── 상태 ──
    let state = {
        category: 'all',
        subcategory: 'all',
        sort: 'latest',
        search: '',
        page: 1,
        totalPages: 1,
        posts: [],
    };

    // ── 카테고리별 광고 매핑 (각 사이드 4개씩) ──
    const COMM_AD_MAP = {
        all:          { left: ['COMM_ALL_L1','COMM_ALL_L2','COMM_ALL_L3','COMM_ALL_L4'],       right: ['COMM_ALL_R1','COMM_ALL_R2','COMM_ALL_R3','COMM_ALL_R4']       },
        band_recruit: { left: ['COMM_BAND_L1','COMM_BAND_L2','COMM_BAND_L3','COMM_BAND_L4'],   right: ['COMM_BAND_R1','COMM_BAND_R2','COMM_BAND_R3','COMM_BAND_R4']   },
        lesson:       { left: ['COMM_LESSON_L1','COMM_LESSON_L2','COMM_LESSON_L3','COMM_LESSON_L4'], right: ['COMM_LESSON_R1','COMM_LESSON_R2','COMM_LESSON_R3','COMM_LESSON_R4'] },
        used_gear:    { left: ['COMM_USED_L1','COMM_USED_L2','COMM_USED_L3','COMM_USED_L4'],   right: ['COMM_USED_R1','COMM_USED_R2','COMM_USED_R3','COMM_USED_R4']   },
        free_talk:    { left: ['COMM_FREE_L1','COMM_FREE_L2','COMM_FREE_L3','COMM_FREE_L4'],   right: ['COMM_FREE_R1','COMM_FREE_R2','COMM_FREE_R3','COMM_FREE_R4']   },
        info:         { left: ['COMM_INFO_L1','COMM_INFO_L2','COMM_INFO_L3','COMM_INFO_L4'],   right: ['COMM_INFO_R1','COMM_INFO_R2','COMM_INFO_R3','COMM_INFO_R4']   },
    };

    function updateCommAds(cat) {
        // 광고 시스템 비활성화됨
    }

    // ── 즉시 실행 (코드 로드 직후) ──
    setupSideMenu();
    setupWriteModal();
    setupDetailModal();

    // ── URL 파라미터로 초기 카테고리 설정 ──
    (function initCatFromUrl() {
        const CAT_MAP = {
            'all': 'all',
            'free': 'free_talk',
            'free_talk': 'free_talk',
            'gear': 'info',
            'info': 'info',
            'band': 'band_recruit',
            'band_recruit': 'band_recruit',
            'lesson': 'lesson',
            'market': 'used_gear',
            'used_gear': 'used_gear',
        };
        const params = new URLSearchParams(window.location.search);
        const catParam = params.get('cat');
        if (catParam && CAT_MAP[catParam]) {
            const mappedCat = CAT_MAP[catParam];
            state.category = mappedCat;
            state.subcategory = 'all';
            // 사이드메뉴 버튼 active 표시 (data-sub="all" 또는 data-sub 없는 버튼 우선)
            let btn = document.querySelector(`.sidebar-section button[data-cat="${mappedCat}"][data-sub="all"]`);
            if (!btn) btn = document.querySelector(`.sidebar-section button[data-cat="${mappedCat}"]:not([data-sub])`);
            if (!btn) btn = document.querySelector(`.sidebar-section button[data-cat="${mappedCat}"]`);
            if (btn) {
                setActiveMenuBtn(btn);
                // 사이드바 섹션이 접혀있으면 펼치기
                const section = btn.closest('.sidebar-section');
                if (section) {
                    const ul = section.querySelector('ul.sidebar-menu');
                    if (ul) ul.style.display = 'block';
                }
            }
            updateCategoryTitle(mappedCat, 'all');
        }
        // 헤더 nav-btn active 상태 업데이트
        document.querySelectorAll('.nav-community-group .nav-btn').forEach(a => {
            a.classList.remove('active');
            try {
                const href = new URL(a.href, location.href);
                const hCat = href.searchParams.get('cat') || 'all';
                const curCat = catParam || 'all';
                if (hCat === curCat) a.classList.add('active');
            } catch(e) {}
        });
    })();

    loadPosts();
    updateTotalCount();
    updateCommAds('all');

    // ─── 사이드 메뉴 ───
    function setupSideMenu() {
        document.querySelectorAll('.comm-sidebar button[data-cat], #sideMenu button[data-cat]').forEach(btn => {
            btn.addEventListener('click', () => {
                const cat = btn.dataset.cat;
                const sub = btn.dataset.sub || 'all';
                state.category = cat;
                state.subcategory = sub;
                state.page = 1;
                state.search = '';
                document.getElementById('searchInput').value = '';
                updateCategoryTitle(cat, sub);
                setActiveMenuBtn(btn);
                loadPosts();
                updateCommAds(cat); // 카테고리 변경 시 광고 갱신
            });
        });
        document.getElementById('sortSelect').addEventListener('change', e => {
            state.sort = e.target.value;
            loadPosts();
        });
        document.getElementById('searchBtn').addEventListener('click', doSearch);
        document.getElementById('searchInput').addEventListener('keydown', e => {
            if (e.key === 'Enter') doSearch();
        });
    }

    function setActiveMenuBtn(active) {
        // 모든 사이드바 버튼 비활성화
        document.querySelectorAll('.comm-sidebar button[data-cat]').forEach(b => b.classList.remove('active'));
        if (active) active.classList.add('active');
    }

    function doSearch() {
        state.search = document.getElementById('searchInput').value.trim();
        state.page = 1;
        loadPosts();
    }

    function updateCategoryTitle(cat, sub) {
        const info = CATEGORY_INFO[cat] || CATEGORY_INFO.all;
        let label = info.label;
        if (sub && sub !== 'all' && SUBCATEGORY_OPTIONS[cat]) {
            const found = SUBCATEGORY_OPTIONS[cat].find(o => o.value === sub);
            if (found) label = found.label;
        }
        document.getElementById('categoryTitle').innerHTML = `
            <span class="icon-badge" style="background:#fff7f0;">${info.icon}</span>
            ${label}
        `;
    }

    // ─── 데이터 로드 ───
    async function loadPosts() {
        const container = document.getElementById('postContainer');
        container.innerHTML = '<div class="loading-state"><div class="spinner"></div><span>불러오는 중...</span></div>';

        try {
            const limit = 12;
            const result = await SupabaseDB.list('community_posts', {
                limit: 200,
                page: 1,
                search: state.search,
                searchFields: ['title','content','author'],
                sort: 'created_at',
                order: 'desc',
            });
            const data = result;
            let posts = data.data || [];

            // 카테고리 필터 (클라이언트 측)
            if (state.category !== 'all') {
                posts = posts.filter(p => p.category === state.category);
            }
            if (state.subcategory && state.subcategory !== 'all') {
                posts = posts.filter(p => p.subcategory === state.subcategory);
            }

            // 정렬
            if (state.sort === 'views') {
                posts.sort((a, b) => (b.views || 0) - (a.views || 0));
            } else if (state.sort === 'likes') {
                posts.sort((a, b) => (b.likes || 0) - (a.likes || 0));
            } else {
                posts.sort((a, b) => (b.created_at || 0) - (a.created_at || 0));
            }

            state.posts = posts;
            state.totalPages = Math.ceil(posts.length / limit) || 1;

            renderPosts(posts);
            renderPagination();
        } catch (e) {
            container.innerHTML = `<div class="empty-state"><div class="empty-icon">⚠️</div><p>데이터를 불러오지 못했습니다.</p></div>`;
        }
    }

    async function updateTotalCount() {
        try {
            const result = await SupabaseDB.list('community_posts', { limit: 1 });
            document.getElementById('totalPosts').textContent = result.total || 0;
        } catch { document.getElementById('totalPosts').textContent = '-'; }
    }

    // ─── 렌더링 ───
    function renderPosts(posts) {
        const container = document.getElementById('postContainer');
        if (!posts || posts.length === 0) {
            container.innerHTML = `<div class="empty-state"><div class="empty-icon">📭</div><p>등록된 게시글이 없습니다.<br>첫 글을 남겨보세요!</p></div>`;
            return;
        }

        const cat = state.category;

        if (cat === 'used_gear') {
            container.innerHTML = `<div class="gear-grid">${posts.map(renderGearCard).join('')}</div>`;
        } else if (cat === 'lesson') {
            container.innerHTML = `<div class="lesson-grid">${posts.map(renderLessonCard).join('')}</div>`;
        } else if (cat === 'band_recruit') {
            container.innerHTML = `<div class="recruit-grid">${posts.map(renderRecruitCard).join('')}</div>`;
        } else {
            container.innerHTML = `<div class="post-list">${posts.map(renderPostCard).join('')}</div>`;
        }

        // 클릭 이벤트
        container.querySelectorAll('[data-post-id]').forEach(el => {
            el.addEventListener('click', () => openDetail(el.dataset.postId));
        });

        // 카드별 댓글 수 비동기 로드
        loadCommentCounts(posts.map(p => p.id));
    }

    // ─── 카드 댓글 수 비동기 채우기 ───
    async function loadCommentCounts(postIds) {
        if (!postIds || postIds.length === 0) return;
        try {
            const res = await fetch(`${COMMENT_API}?limit=500`);
            if (!res.ok) return;
            const data = await res.json();
            const all = (data.data || []).filter(c => !c.is_deleted);

            // postId 별 카운트
            const countMap = {};
            all.forEach(c => {
                if (!countMap[c.post_id]) countMap[c.post_id] = 0;
                countMap[c.post_id]++;
            });

            // 각 카드 업데이트
            postIds.forEach(pid => {
                const cnt = countMap[pid] || 0;
                const el = document.querySelector(`[data-post-id="${pid}"] .comment-cnt-val`);
                if (el) el.textContent = cnt;
            });
        } catch { /* silent */ }
    }

    function getCategoryBadge(cat, sub) {
        const info = CATEGORY_INFO[cat] || {};
        const cls = info.badge || 'badge-talk';
        let label = info.label || cat;
        if (sub && sub !== 'all' && SUBCATEGORY_OPTIONS[cat]) {
            const f = SUBCATEGORY_OPTIONS[cat].find(o => o.value === sub);
            if (f) label = f.label;
        }
        return `<span class="post-category-badge ${cls}">${label}</span>`;
    }

    function fmtPrice(p) {
        if (!p) return '';
        return Number(p).toLocaleString('ko-KR') + '원';
    }

    function fmtDate(ts) {
        if (!ts) return '';
        const d = new Date(ts);
        const now = new Date();
        const diff = Math.floor((now - d) / 60000);
        if (diff < 1) return '방금';
        if (diff < 60) return `${diff}분 전`;
        if (diff < 1440) return `${Math.floor(diff/60)}시간 전`;
        return d.toLocaleDateString('ko-KR', { month: '2-digit', day: '2-digit' });
    }

    function renderPostCard(p) {
        const tags = Array.isArray(p.tags) ? p.tags.slice(0, 3).map(t => `<span class="tag">#${t}</span>`).join('') : '';
        const priceHtml = p.price ? `<span class="post-price">${fmtPrice(p.price)}</span>` : '';
        const thumbHtml = p.image_url
            ? `<div class="post-card-thumb">
                <img src="${escHtml(p.image_url)}" alt=""
                    onerror="this.parentElement.style.display='none'">
               </div>` : '';
        return `
        <div class="post-card${p.image_url ? ' post-card--has-img' : ''}" data-post-id="${p.id}">
            <div class="post-card-top">
                ${getCategoryBadge(p.category, p.subcategory)}
                <div class="post-title-area">
                    <div class="post-title">${escHtml(p.title || '')}</div>
                    <div class="post-preview">${escHtml((p.content || '').replace(/<[^>]+>/g, '').slice(0, 60))}...</div>
                </div>
                ${thumbHtml}
                ${priceHtml}
            </div>
            ${tags ? `<div class="post-tags">${tags}</div>` : ''}
            <div class="post-meta">
                <span><i class="fas fa-user"></i> ${escHtml(p.author || '익명')}</span>
                ${p.location ? `<span><i class="fas fa-map-marker-alt"></i> ${escHtml(p.location)}</span>` : ''}
                <span class="meta-views"><i class="fas fa-eye"></i> ${p.views || 0}</span>
                <span><i class="fas fa-heart"></i> ${p.likes || 0}</span>
                <span class="comment-cnt"><i class="fas fa-comment"></i> <span class="comment-cnt-val">0</span></span>
                <span class="meta-date"><i class="fas fa-clock"></i> ${fmtDate(p.created_at)}</span>
            </div>
        </div>`;
    }

    function renderGearCard(p) {
        const sub = SUBCATEGORY_OPTIONS.used_gear
            ? SUBCATEGORY_OPTIONS.used_gear.find(o => o.value === p.subcategory) : null;
        const subLabel = sub ? sub.label : p.subcategory || '중고';
        const icon = GEAR_ICON[p.subcategory] || '🎼';

        const statusBadge = p.status === 'sold'
            ? `<span class="gear-status-badge status-sold">판매완료</span>`
            : `<span class="gear-status-badge status-active">판매중</span>`;

        // 이미지 영역: 실제 사진이 있으면 사진, 없으면 이모지 배경
        const imgArea = p.image_url
            ? `<div class="gear-card-photo">
                <img src="${escHtml(p.image_url)}" alt="${escHtml(p.title || '')}"
                    onerror="this.parentElement.innerHTML='<span class=\\"gear-card-noimg\\">${icon}</span>'">
                ${statusBadge}
               </div>`
            : `<div class="gear-card-noimg-wrap">
                <span class="gear-card-noimg-icon">${icon}</span>
                ${statusBadge}
               </div>`;

        const priceLabel = p.price ? fmtPrice(p.price) : '가격 협의';

        return `
        <div class="gear-card${p.status === 'sold' ? ' gear-card--sold' : ''}" data-post-id="${p.id}">
            ${imgArea}
            <div class="gear-card-body">
                <div class="gear-card-sub-row">
                    <span class="gear-card-sub-badge">${subLabel}</span>
                    <span class="gear-card-date">${fmtDate(p.created_at)}</span>
                </div>
                <div class="gear-card-title">${escHtml(p.title || '')}</div>
                <div class="gear-card-location">
                    ${p.location ? `<i class="fas fa-map-marker-alt"></i> ${escHtml(p.location)}` : ''}
                </div>
                <div class="gear-card-price-row">
                    <span class="gear-card-price">${priceLabel}</span>
                    ${p.contact ? `<span class="gear-card-contact-chip"><i class="fas fa-phone-alt"></i> 연락처 있음</span>` : ''}
                </div>
                <div class="gear-card-meta">
                    <span><i class="fas fa-eye"></i> ${p.views || 0}</span>
                    <span class="comment-cnt"><i class="fas fa-comment"></i> <span class="comment-cnt-val">0</span></span>
                    <span><i class="fas fa-user"></i> ${escHtml(p.author || '익명')}</span>
                </div>
            </div>
        </div>`;
    }

    function renderLessonCard(p) {
        const sub = SUBCATEGORY_OPTIONS.lesson.find(o => o.value === p.subcategory);
        const subLabel = sub ? sub.label : '레슨';
        const icons = { guitar: '🎸', bass: '🎵', drum: '🥁', vocal: '🎤', keyboard: '🎹' };
        const icon = icons[p.subcategory] || '🎓';
        const thumbHtml = p.image_url
            ? `<div class="lesson-card-thumb">
                <img src="${escHtml(p.image_url)}" alt=""
                    onerror="this.parentElement.style.display='none'">
               </div>` : '';
        return `
        <div class="lesson-card" data-post-id="${p.id}">
            ${thumbHtml}
            <div class="lesson-card-header">
                <div class="lesson-avatar">${icon}</div>
                <div>
                    <div class="lesson-card-title">${escHtml(p.title || '')}</div>
                    <div class="lesson-card-author"><i class="fas fa-user"></i> ${escHtml(p.author || '익명')} · ${p.location ? escHtml(p.location) : ''}</div>
                </div>
            </div>
            <div class="lesson-card-desc">${escHtml((p.content || '').replace(/<[^>]+>/g, ''))}</div>
            <div class="lesson-price-row">
                <div class="lesson-price">${p.price ? fmtPrice(p.price) + '/회' : '협의'}</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span class="comment-cnt" style="font-size:0.75rem;"><i class="fas fa-comment"></i> <span class="comment-cnt-val">0</span></span>
                    <span class="lesson-badge">${subLabel}</span>
                </div>
            </div>
        </div>`;
    }

    function renderRecruitCard(p) {
        const sub = SUBCATEGORY_OPTIONS.band_recruit.find(o => o.value === p.subcategory);
        const subLabel = sub ? sub.label : '구인';
        const icons = { guitarist: '🎸', bassist: '🎵', drummer: '🥁', vocalist: '🎤', keyboardist: '🎹', band_join: '🔍' };
        const icon = icons[p.subcategory] || '🎸';
        const tags = Array.isArray(p.tags) ? p.tags.slice(0, 3).map(t =>
            `<span class="recruit-tag">${escHtml(t)}</span>`).join('') : '';
        const locTag = p.location ? `<span class="recruit-location"><i class="fas fa-map-marker-alt"></i> ${escHtml(p.location)}</span>` : '';
        const thumbHtml = p.image_url
            ? `<div class="recruit-card-thumb">
                <img src="${escHtml(p.image_url)}" alt=""
                    onerror="this.parentElement.style.display='none'">
               </div>` : '';
        return `
        <div class="recruit-card" data-post-id="${p.id}">
            ${thumbHtml}
            <div class="recruit-header">
                <div class="recruit-icon">${icon}</div>
                <div>
                    <div class="recruit-title">${escHtml(p.title || '')}</div>
                    <div class="recruit-author">${escHtml(p.author || '익명')} · <i class="fas fa-eye"></i> ${p.views || 0} · ${fmtDate(p.created_at)}</div>
                </div>
            </div>
            <div class="recruit-body">${escHtml((p.content || '').replace(/<[^>]+>/g, ''))}</div>
            <div class="recruit-footer">${tags}${locTag}</div>
            <div style="padding-top:8px;">
                <span class="comment-cnt"><i class="fas fa-comment"></i> <span class="comment-cnt-val">0</span> 댓글</span>
            </div>
        </div>`;
    }

    // ─── 페이지네이션 ───
    function renderPagination() {
        const pg = document.getElementById('pagination');
        if (state.totalPages <= 1) { pg.innerHTML = ''; return; }
        let html = '';
        for (let i = 1; i <= Math.min(state.totalPages, 10); i++) {
            html += `<button class="page-btn${i === state.page ? ' active' : ''}" data-page="${i}">${i}</button>`;
        }
        pg.innerHTML = html;
        pg.querySelectorAll('.page-btn').forEach(b => {
            b.addEventListener('click', () => {
                state.page = parseInt(b.dataset.page);
                loadPosts();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
    }

    // ─── 게시글 상세 ───
    function openDetail(postId) {
        const p = state.posts.find(x => x.id === postId);
        if (!p) return;

        const info = CATEGORY_INFO[p.category] || {};
        const badge = getCategoryBadge(p.category, p.subcategory);
        document.getElementById('detailCategoryBadge').innerHTML = badge;

        const tags = Array.isArray(p.tags) ? p.tags.map(t => `<span class="tag">#${t}</span>`).join('') : '';
        const priceHtml = p.price ? `
            <div class="detail-price-box">
                <div class="price-lbl">💰 판매가격</div>
                <div class="price-val">${fmtPrice(p.price)}</div>
            </div>` : '';
        const contactHtml = p.contact ? `
            <div class="detail-contact">
                <strong><i class="fas fa-phone-alt"></i> 판매자 연락처</strong>
                <span class="detail-contact-value">${escHtml(p.contact)}</span>
            </div>` : '';
        const imageHtml = p.image_url ? `
            <div class="detail-product-img">
                <img src="${escHtml(p.image_url)}" alt="${escHtml(p.title || '첨부 이미지')}"
                    onerror="this.parentElement.style.display='none'">
            </div>` : '';

        document.getElementById('detailContent').innerHTML = `
            <div class="detail-title">${escHtml(p.title || '')}</div>
            <div class="detail-meta">
                <span><i class="fas fa-user"></i> ${escHtml(p.author || '익명')}</span>
                ${p.location ? `<span><i class="fas fa-map-marker-alt"></i> ${escHtml(p.location)}</span>` : ''}
                <span><i class="fas fa-eye"></i> ${p.views || 0}</span>
                <span><i class="fas fa-heart"></i> ${p.likes || 0}</span>
                <span><i class="fas fa-clock"></i> ${fmtDate(p.created_at)}</span>
            </div>
            ${imageHtml}
            ${priceHtml}
            <div class="detail-body">${escHtml((p.content || '').replace(/<[^>]+>/g, ''))}</div>
            ${tags ? `<div class="detail-tags">${tags}</div>` : ''}
            ${contactHtml}
        `;

        document.getElementById('detailModal').classList.add('open');
        // 조회수 증가
        incrementViews(p.id, p.views || 0);
        // 댓글 로드
        loadComments(p.id);
    }

    async function incrementViews(id, currentViews) {
        try {
            await SupabaseDB.update('community_posts', id, { views: currentViews + 1 });
        } catch {}
    }

    function setupDetailModal() {
        document.getElementById('closeDetailModal').addEventListener('click', () => {
            document.getElementById('detailModal').classList.remove('open');
        });
        document.getElementById('closeDetailBtn').addEventListener('click', () => {
            document.getElementById('detailModal').classList.remove('open');
        });
        document.getElementById('detailModal').addEventListener('click', e => {
            if (e.target === e.currentTarget) e.currentTarget.classList.remove('open');
        });
        // 댓글 기능 초기화
        setupComments();
    }

    // ─── 글쓰기 모달 ───
    function setupWriteModal() {
        document.getElementById('writeBtn').addEventListener('click', openWriteModal);
        document.getElementById('closeWriteModal').addEventListener('click', closeWriteModal);
        document.getElementById('cancelWrite').addEventListener('click', closeWriteModal);
        document.getElementById('writeModal').addEventListener('click', e => {
            if (e.target === e.currentTarget) closeWriteModal();
        });
        document.getElementById('formCategory').addEventListener('change', onCategoryChange);
        document.getElementById('submitPost').addEventListener('click', submitPost);

        // ── 이미지 업로드 이벤트 ──
        const zone      = document.getElementById('imgUploadZone');
        const fileInput = document.getElementById('formImageFile');

        // 클릭으로 파일 선택
        zone.addEventListener('click', () => {
            if (!document.getElementById('imgUploadPreview').style.display ||
                document.getElementById('imgUploadPreview').style.display === 'none') {
                fileInput.click();
            }
        });

        // 파일 선택 시 미리보기
        fileInput.addEventListener('change', () => {
            if (fileInput.files[0]) handleImageFile(fileInput.files[0]);
        });

        // 드래그&드롭
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
        zone.addEventListener('drop', e => {
            e.preventDefault();
            zone.classList.remove('drag-over');
            const f = e.dataTransfer.files[0];
            if (f && f.type.startsWith('image/')) handleImageFile(f);
        });

        // 사진 제거 버튼
        document.getElementById('imgRemoveBtn').addEventListener('click', e => {
            e.stopPropagation();
            clearImageUpload();
        });
    }

    function openWriteModal() {
        // 로그인 여부 확인
        if (!currentUser) {
            showToast('✋ 글쓰기는 로그인 후 이용할 수 있어요!');
            setTimeout(() => { location.href = 'login.html?redirect=community.html'; }, 1200);
            return;
        }
        // 현재 카테고리 기본값 설정
        if (state.category !== 'all') {
            document.getElementById('formCategory').value = state.category;
            onCategoryChange();
        }
        // 닉네임 자동 입력
        const authorField = document.getElementById('formAuthor');
        if (authorField && currentProfile?.nickname) {
            authorField.value = currentProfile.nickname;
            authorField.readOnly = true;
        }
        document.getElementById('writeModal').classList.add('open');
    }

    function closeWriteModal() {
        document.getElementById('writeModal').classList.remove('open');
        resetWriteForm();
    }

    // ── 이미지 파일 선택 처리 ──
    let _pendingImageFile = null; // 업로드 대기 파일 (submit 시 실제 업로드)

    function handleImageFile(file) {
        const allowed = ['image/jpeg','image/jpg','image/png','image/gif','image/webp'];
        if (!allowed.includes(file.type)) {
            showToast('⚠️ JPG, PNG, GIF, WebP 이미지만 가능합니다.');
            return;
        }
        if (file.size > 5 * 1024 * 1024) {
            showToast('⚠️ 이미지 크기는 5MB 이하만 가능합니다.');
            return;
        }
        _pendingImageFile = file;

        // 미리보기
        const reader = new FileReader();
        reader.onload = e => {
            const placeholder = document.getElementById('imgUploadPlaceholder');
            const preview     = document.getElementById('imgUploadPreview');
            const previewImg  = document.getElementById('imgPreviewImg');
            const info        = document.getElementById('imgUploadInfo');

            placeholder.style.display = 'none';
            previewImg.src = e.target.result;
            info.textContent = `${file.name}  (${(file.size/1024).toFixed(0)}KB)`;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    function clearImageUpload() {
        _pendingImageFile = null;
        document.getElementById('formImageFile').value = '';
        document.getElementById('imgUploadPlaceholder').style.display = 'flex';
        document.getElementById('imgUploadPreview').style.display = 'none';
        document.getElementById('imgPreviewImg').src = '';
    }

    function resetWriteForm() {
        ['formCategory','formTitle','formAuthor','formLocation','formPrice','formContact','formContent','formTags']
            .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        document.getElementById('subCatGroup').style.display = 'none';
        document.getElementById('priceGroup').style.display = 'none';
        document.getElementById('contactGroup').style.display = 'none';
        clearImageUpload();
    }

    function onCategoryChange() {
        const cat = document.getElementById('formCategory').value;
        const subGrp = document.getElementById('subCatGroup');
        const priceGrp = document.getElementById('priceGroup');
        const contactGrp = document.getElementById('contactGroup');

        // 서브카테고리
        const opts = SUBCATEGORY_OPTIONS[cat];
        if (opts && opts.length > 0) {
            const subSel = document.getElementById('formSubcategory');
            subSel.innerHTML = opts.map(o => `<option value="${o.value}">${o.label}</option>`).join('');
            subGrp.style.display = 'block';
        } else {
            subGrp.style.display = 'none';
        }

        // 이미지 URL — 모든 카테고리에서 항상 표시

        // 가격 필드
        priceGrp.style.display = (cat === 'used_gear') ? 'block' : 'none';

        // 연락처: 중고장터·레슨·밴드구인 모두 표시, 중고는 필수 표시
        contactGrp.style.display = (cat === 'used_gear' || cat === 'lesson' || cat === 'band_recruit') ? 'block' : 'none';
        const reqMark = document.getElementById('contactRequired');
        if (reqMark) {
            if (cat === 'used_gear') {
                reqMark.innerHTML = '<span style="color:#ef4444;">*</span>';
                document.getElementById('formContact').placeholder = '전화번호 또는 카카오톡 ID (필수)';
            } else {
                reqMark.innerHTML = '<span style="color:#9ca3af;font-size:.75rem;">(선택)</span>';
                document.getElementById('formContact').placeholder = '카카오톡 ID, 인스타그램 등';
            }
        }
    }

    async function submitPost() {
        const cat    = document.getElementById('formCategory').value;
        const title  = document.getElementById('formTitle').value.trim();
        const author = document.getElementById('formAuthor').value.trim();
        const content= document.getElementById('formContent').value.trim();

        if (!cat || !title || !author || !content) {
            showToast('⚠️ 카테고리, 제목, 작성자, 내용을 입력해주세요.');
            return;
        }

        // 중고장터 필수 항목 검증
        if (cat === 'used_gear') {
            const price = document.getElementById('formPrice').value;
            const contact = document.getElementById('formContact').value.trim();
            if (!price || parseInt(price) <= 0) {
                showToast('⚠️ 중고장터는 판매 가격을 입력해주세요.');
                return;
            }
            if (!contact) {
                showToast('⚠️ 중고장터는 판매자 연락처를 입력해주세요.');
                return;
            }
        }

        const subSel = document.getElementById('formSubcategory');
        const subcat = subSel && document.getElementById('subCatGroup').style.display !== 'none'
            ? subSel.value : '';
        const location= document.getElementById('formLocation').value.trim();
        const price   = document.getElementById('priceGroup').style.display !== 'none'
            ? parseInt(document.getElementById('formPrice').value) || 0 : 0;
        const contact = document.getElementById('formContact').value.trim();
        const tagsRaw = document.getElementById('formTags').value.trim();
        const tags    = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];

        const btn = document.getElementById('submitPost');
        btn.disabled = true;

        // ── 이미지 업로드 처리 ──
        let imageUrl = null;
        if (_pendingImageFile) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 사진 업로드 중...';
            try {
                imageUrl = await uploadImageToSupabase(_pendingImageFile);
            } catch (err) {
                showToast(`⚠️ ${err.message}`);
                btn.disabled = false;
                btn.textContent = '등록하기';
                return;
            }
        }

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 등록 중...';

        try {
            await SupabaseDB.create('community_posts', {
                category: cat,
                subcategory: subcat,
                title, author, content, location,
                price: price || null,
                contact: contact || null,
                image_url: imageUrl || null,
                tags,
                views: 0,
                likes: 0,
                status: 'active'
            });

            closeWriteModal();
            showToast('✅ 게시글이 등록되었습니다!');
            // 해당 카테고리로 이동
            state.category = cat;
            state.subcategory = 'all';
            state.page = 1;
            updateCategoryTitle(cat, 'all');
            loadPosts();
            updateTotalCount();
        } catch {
            showToast('❌ 등록에 실패했습니다. 다시 시도해주세요.');
        } finally {
            btn.disabled = false;
            btn.textContent = '등록하기';
        }
    }
    function escHtml(str) {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
    }

    let _toastTimer;
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        clearTimeout(_toastTimer);
        _toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
    }

    /* ═══════════════════════════════════════════════════
       댓글 기능 v1.0
       - 댓글 목록 로드 / 등록 / 삭제 / 대댓글 / 좋아요
       ═══════════════════════════════════════════════════ */
    const COMMENT_API = 'community_comments'; // Supabase 테이블명

    // 현재 열린 게시글 ID
    let _currentPostId = null;
    // 댓글 캐시: { [postId]: [commentObj, ...] }
    const _commentCache = {};

    // ─── 댓글 초기화 (setupDetailModal 에서 호출) ───
    function setupComments() {
        // 댓글 등록 버튼
        document.getElementById('submitCommentBtn').addEventListener('click', submitComment);

        // 엔터(Ctrl+Enter) 단축키
        document.getElementById('newCommentText').addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') submitComment();
        });

        // 글자수 카운터
        document.getElementById('newCommentText').addEventListener('input', () => {
            const len = document.getElementById('newCommentText').value.length;
            document.getElementById('newCommentCharCount').textContent = `${len}/500`;
        });
    }

    // ─── 댓글 로드 ───
    async function loadComments(postId) {
        _currentPostId = postId;
        const listEl = document.getElementById('commentList');
        const badgeEl = document.getElementById('commentCountBadge');

        listEl.innerHTML = '<div class="comment-loading"><div class="comment-spinner"></div> 댓글 불러오는 중...</div>';
        badgeEl.textContent = '…';

        try {
            // Supabase: post_id 필터를 서버에서 처리
            const result = await SupabaseDB.list('community_comments', {
                limit: 500,
                filters: { post_id: postId },
                sort: 'created_at',
                order: 'asc',
            });
            // 삭제되지 않은 댓글만
            const all = (result.data || []).filter(c => !c.is_deleted);

            _commentCache[postId] = all;
            renderComments(all, postId);

            // 뱃지
            const total = all.length;
            badgeEl.textContent = total;
        } catch {
            listEl.innerHTML = '<div class="comment-empty">댓글을 불러오지 못했습니다.</div>';
            badgeEl.textContent = '0';
        }
    }

    // ─── 댓글 렌더링 ───
    function renderComments(comments, postId) {
        const listEl = document.getElementById('commentList');

        if (!comments || comments.length === 0) {
            listEl.innerHTML = '<div class="comment-empty">아직 댓글이 없습니다. 첫 댓글을 남겨보세요! 💬</div>';
            return;
        }

        // 부모/자식 구조 분리
        const roots   = comments.filter(c => !c.parent_id);
        const replies  = comments.filter(c =>  c.parent_id);

        let html = '<div class="comment-list">';
        roots.forEach(root => {
            html += buildCommentHTML(root, false);
            // 이 댓글에 달린 대댓글
            const children = replies.filter(r => r.parent_id === root.id);
            children.forEach(child => {
                html += buildCommentHTML(child, true);
            });
        });
        html += '</div>';
        listEl.innerHTML = html;

        // 이벤트 바인딩
        bindCommentEvents(listEl, postId);
    }

    function buildCommentHTML(c, isReply) {
        const initial = (c.author || '?')[0].toUpperCase();
        const replyClass = isReply ? ' is-reply' : '';
        const likesNum = c.likes || 0;
        const replyBtn = !isReply
            ? `<button class="comment-action-btn reply-toggle-btn" data-comment-id="${c.id}"><i class="fas fa-reply"></i> 답글</button>`
            : '';
        return `
        <div class="comment-item${replyClass}" data-cid="${c.id}">
            <div class="comment-header">
                <div class="comment-avatar">${escHtml(initial)}</div>
                <span class="comment-author-name">${escHtml(c.author || '익명')}</span>
                <span class="comment-date">${fmtDate(c.created_at)}</span>
                <div class="comment-actions">
                    ${replyBtn}
                    <button class="comment-action-btn like-btn${likesNum > 0 ? ' like-active' : ''}" data-comment-id="${c.id}" data-likes="${likesNum}">
                        <i class="fas fa-thumbs-up"></i> ${likesNum > 0 ? likesNum : ''}
                    </button>
                    <button class="comment-action-btn delete-btn" data-comment-id="${c.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="comment-body">${escHtml(c.content || '')}</div>
            ${!isReply ? `
            <div class="reply-form-wrap" id="replyForm-${c.id}">
                <div class="reply-form">
                    <input type="text" class="reply-author-input" id="replyAuthor-${c.id}" placeholder="닉네임" maxlength="20" />
                    <textarea class="reply-textarea" id="replyText-${c.id}" placeholder="답글을 입력하세요..." maxlength="300" rows="2"></textarea>
                    <div class="reply-btns">
                        <button class="reply-submit-btn" data-parent-id="${c.id}"><i class="fas fa-paper-plane"></i> 등록</button>
                        <button class="reply-cancel-btn" data-target="replyForm-${c.id}">취소</button>
                    </div>
                </div>
            </div>` : ''}
        </div>`;
    }

    // ─── 이벤트 바인딩 ───
    function bindCommentEvents(container, postId) {
        // 답글 토글
        container.querySelectorAll('.reply-toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const cid = btn.dataset.commentId;
                const formWrap = document.getElementById(`replyForm-${cid}`);
                if (!formWrap) return;
                const isOpen = formWrap.classList.contains('open');
                // 다른 답글 폼 모두 닫기
                container.querySelectorAll('.reply-form-wrap.open').forEach(w => w.classList.remove('open'));
                if (!isOpen) {
                    formWrap.classList.add('open');
                    document.getElementById(`replyAuthor-${cid}`)?.focus();
                }
            });
        });

        // 답글 취소
        container.querySelectorAll('.reply-cancel-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.dataset.target;
                document.getElementById(targetId)?.classList.remove('open');
            });
        });

        // 답글 등록
        container.querySelectorAll('.reply-submit-btn').forEach(btn => {
            btn.addEventListener('click', () => submitReply(btn.dataset.parentId, postId));
        });

        // 답글 Ctrl+Enter
        container.querySelectorAll('.reply-textarea').forEach(ta => {
            ta.addEventListener('keydown', e => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    const parentId = ta.id.replace('replyText-', '');
                    submitReply(parentId, postId);
                }
            });
        });

        // 좋아요
        container.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', () => likeComment(btn, postId));
        });

        // 삭제
        container.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => deleteComment(btn.dataset.commentId, postId));
        });
    }

    // ─── 댓글 등록 ───
    async function submitComment() {
        const author  = document.getElementById('newCommentAuthor').value.trim();
        const content = document.getElementById('newCommentText').value.trim();

        if (!author) { showToast('⚠️ 닉네임을 입력해주세요.'); return; }
        if (!content) { showToast('⚠️ 댓글 내용을 입력해주세요.'); return; }
        if (!_currentPostId) return;

        const btn = document.getElementById('submitCommentBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 등록 중...';

        try {
            await SupabaseDB.create('community_comments', {
                post_id: _currentPostId,
                parent_id: null,
                author,
                content,
                likes: 0,
                is_deleted: false
            });

            // 입력 초기화
            document.getElementById('newCommentText').value = '';
            document.getElementById('newCommentCharCount').textContent = '0/500';

            showToast('✅ 댓글이 등록되었습니다!');
            await loadComments(_currentPostId);

            // 게시글 카드의 댓글 수도 갱신
            refreshCommentCount(_currentPostId);
        } catch {
            showToast('❌ 댓글 등록에 실패했습니다.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> 댓글 등록';
        }
    }

    // ─── 대댓글 등록 ───
    async function submitReply(parentId, postId) {
        const authorEl  = document.getElementById(`replyAuthor-${parentId}`);
        const contentEl = document.getElementById(`replyText-${parentId}`);
        const author  = authorEl?.value.trim();
        const content = contentEl?.value.trim();

        if (!author)  { showToast('⚠️ 닉네임을 입력해주세요.'); return; }
        if (!content) { showToast('⚠️ 답글 내용을 입력해주세요.'); return; }

        try {
            await SupabaseDB.create('community_comments', {
                post_id: postId,
                parent_id: parentId,
                author,
                content,
                likes: 0,
                is_deleted: false
            });

            showToast('✅ 답글이 등록되었습니다!');
            await loadComments(postId);
            refreshCommentCount(postId);
        } catch {
            showToast('❌ 답글 등록에 실패했습니다.');
        }
    }

    // ─── 댓글 좋아요 ───
    async function likeComment(btn, postId) {
        const cid    = btn.dataset.commentId;
        const likes  = parseInt(btn.dataset.likes) || 0;
        const newVal = likes + 1;
        btn.disabled = true;

        try {
            await SupabaseDB.update('community_comments', cid, { likes: newVal });
            btn.dataset.likes = newVal;
            btn.classList.add('like-active');
            btn.innerHTML = `<i class="fas fa-thumbs-up"></i> ${newVal}`;
        } catch {
            showToast('❌ 좋아요 처리에 실패했습니다.');
        } finally {
            btn.disabled = false;
        }
    }

    // ─── 댓글 삭제 ───
    async function deleteComment(cid, postId) {
        if (!confirm('댓글을 삭제하시겠습니까?')) return;

        try {
            await SupabaseDB.update('community_comments', cid, { is_deleted: true, content: '삭제된 댓글입니다.' });
            showToast('🗑️ 댓글이 삭제되었습니다.');
            await loadComments(postId);
            refreshCommentCount(postId);
        } catch {
            showToast('❌ 삭제에 실패했습니다.');
        }
    }

    // ─── 게시글 카드 댓글 수 갱신 ───
    function refreshCommentCount(postId) {
        const cached = _commentCache[postId];
        if (!cached) return;
        const cnt = cached.length;
        // 목록 카드의 댓글 수 스팬 업데이트
        const el = document.querySelector(`[data-post-id="${postId}"] .comment-cnt-val`);
        if (el) el.textContent = cnt;
    }
    </script>
    <script>
    // 햄버거 메뉴
    // Auth 초기화 (페이지 로드 시)
    initAuth();

    // 커뮤니티 드롭다운
    function toggleCommunityDropdown(e) {
        e.stopPropagation();
        const dd = document.getElementById('communityDropdown');
        if (dd) dd.classList.toggle('open');
    }
    document.addEventListener('click', function(e) {
        const dd = document.getElementById('communityDropdown');
        if (dd && !dd.contains(e.target)) dd.classList.remove('open');
    });

    document.addEventListener('DOMContentLoaded', function() {
        const btn = document.getElementById('hamburgerBtn');
        const menu = document.getElementById('mobileMenu');
        if (btn && menu) {
            btn.addEventListener('click', function() {
                const isOpen = menu.classList.toggle('is-open');
                btn.classList.toggle('is-open', isOpen);
            });
            document.addEventListener('click', function(e) {
                if (!btn.contains(e.target) && !menu.contains(e.target)) {
                    menu.classList.remove('is-open');
                    btn.classList.remove('is-open');
                }
            });
        }
    });
    </script>
</body>
</html>
