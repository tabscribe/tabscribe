<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>관리자 대시보드 — 코드덕쿠</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="images/og-thumbnail.png" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet" />
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --orange: #e85d04;
      --orange2: #f4a261;
      --dark: #0f172a;
      --dark2: #1e293b;
      --text: #f1f5f9;
      --text2: #94a3b8;
      --border: #334155;
      --card: #1e293b;
      --red: #ef4444;
      --green: #22c55e;
      --blue: #3b82f6;
      --purple: #a855f7;
      --yellow: #f59e0b;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Noto Sans KR', 'Inter', sans-serif;
      background: var(--dark);
      color: var(--text);
      min-height: 100vh;
    }

    /* ───── 로딩 화면 ───── */
    #loadingScreen {
      position: fixed; inset: 0;
      background: var(--dark);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      z-index: 9999;
      gap: 16px;
    }
    #loadingScreen .spinner {
      width: 48px; height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--orange);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    #loadingScreen p { color: var(--text2); font-size: 0.9rem; }

    /* ───── 접근 거부 화면 ───── */
    #accessDenied {
      display: none;
      position: fixed; inset: 0;
      background: var(--dark);
      align-items: center; justify-content: center;
      flex-direction: column; gap: 16px;
      z-index: 9998;
    }
    #accessDenied i { font-size: 3rem; color: var(--red); }
    #accessDenied h2 { font-size: 1.4rem; }
    #accessDenied p { color: var(--text2); font-size: 0.9rem; }
    #accessDenied a {
      margin-top: 8px;
      padding: 10px 24px;
      background: var(--orange);
      color: #fff; border-radius: 8px;
      text-decoration: none; font-weight: 700;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ───── 메인 레이아웃 ───── */
    #adminApp { display: none; }

    .admin-layout {
      display: flex;
      min-height: 100vh;
    }

    /* ───── 사이드바 ───── */
    .sidebar {
      width: 240px;
      background: var(--dark2);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0; left: 0;
      height: 100vh;
      z-index: 100;
      transition: transform 0.3s;
    }
    .sidebar-logo {
      padding: 24px 20px 16px;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-logo .logo-badge {
      display: inline-flex; align-items: center; gap: 8px;
      font-size: 1rem; font-weight: 800; color: var(--orange);
      text-decoration: none;
    }
    .sidebar-logo .admin-tag {
      font-size: 0.6rem; font-weight: 700;
      background: var(--orange); color: #fff;
      padding: 2px 6px; border-radius: 4px;
      margin-left: 4px;
    }
    .sidebar-user {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      font-size: 0.78rem; color: var(--text2);
    }
    .sidebar-user strong { color: var(--text); display: block; margin-bottom: 2px; }

    .sidebar-nav {
      flex: 1;
      padding: 12px 0;
      overflow-y: auto;
    }
    .nav-section-label {
      padding: 8px 20px 4px;
      font-size: 0.62rem; font-weight: 700;
      color: var(--text2); letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 20px;
      font-size: 0.82rem; color: var(--text2);
      cursor: pointer; text-decoration: none;
      transition: background 0.15s, color 0.15s;
      border-left: 3px solid transparent;
    }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text); }
    .nav-item.active {
      background: rgba(232,93,4,0.12);
      color: var(--orange);
      border-left-color: var(--orange);
      font-weight: 600;
    }
    .nav-item i { width: 18px; text-align: center; font-size: 0.9rem; }

    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      font-size: 0.72rem; color: var(--text2);
    }
    .sidebar-footer a {
      color: var(--text2); text-decoration: none;
      display: flex; align-items: center; gap: 6px;
      padding: 6px 0;
      transition: color 0.15s;
    }
    .sidebar-footer a:hover { color: var(--text); }

    /* ───── 메인 컨텐츠 ───── */
    .main-content {
      margin-left: 240px;
      flex: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ───── 상단 헤더 ───── */
    .top-bar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 28px;
      background: var(--dark2);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 50;
    }
    .top-bar h1 { font-size: 1.1rem; font-weight: 700; }
    .top-bar-right { display: flex; align-items: center; gap: 12px; }
    .refresh-btn {
      display: flex; align-items: center; gap: 6px;
      padding: 7px 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text2); font-size: 0.78rem;
      cursor: pointer; transition: all 0.2s;
    }
    .refresh-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }
    .refresh-btn.loading i { animation: spin 0.8s linear infinite; }

    /* ───── 섹션 ───── */
    .content-section {
      padding: 28px;
      display: none;
    }
    .content-section.active { display: block; }

    .section-title {
      font-size: 1rem; font-weight: 700;
      margin-bottom: 20px;
      display: flex; align-items: center; gap: 8px;
    }
    .section-title i { color: var(--orange); }

    /* ───── 통계 카드 ───── */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 28px;
    }
    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); }
    .stat-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0;
      height: 3px;
    }
    .stat-card.orange::before { background: var(--orange); }
    .stat-card.green::before  { background: var(--green); }
    .stat-card.blue::before   { background: var(--blue); }
    .stat-card.purple::before { background: var(--purple); }
    .stat-card.yellow::before { background: var(--yellow); }
    .stat-card.red::before    { background: var(--red); }
    .stat-card.teal::before   { background: #14b8a6; }
    .stat-card.indigo::before { background: #6366f1; }
    .stat-card.cyan::before   { background: #06b6d4; }

    .stat-label {
      font-size: 0.72rem; color: var(--text2); font-weight: 500;
      margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
    }
    .stat-value {
      font-size: 2rem; font-weight: 800; line-height: 1;
      margin-bottom: 6px;
    }
    .stat-sub {
      font-size: 0.7rem; color: var(--text2);
    }
    .stat-icon {
      position: absolute; right: 16px; top: 16px;
      font-size: 1.6rem; opacity: 0.15;
    }

    /* ───── 차트 영역 ───── */
    .chart-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 28px;
    }
    .chart-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    .chart-card h3 {
      font-size: 0.82rem; font-weight: 600;
      color: var(--text2); margin-bottom: 16px;
      display: flex; align-items: center; gap: 6px;
    }
    .chart-card h3 i { color: var(--orange); }
    .chart-wrap { height: 220px; position: relative; }

    /* ───── 테이블 ───── */
    .data-table-wrap {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 24px;
    }
    .table-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    .table-header h3 {
      font-size: 0.85rem; font-weight: 700;
      display: flex; align-items: center; gap: 8px;
    }
    .table-header h3 i { color: var(--orange); }
    .table-actions { display: flex; gap: 8px; }
    .tbl-btn {
      padding: 6px 12px;
      border-radius: 6px; border: 1px solid var(--border);
      background: transparent; color: var(--text2);
      font-size: 0.72rem; cursor: pointer;
      transition: all 0.2s; display: flex; align-items: center; gap: 4px;
    }
    .tbl-btn:hover { background: rgba(255,255,255,0.06); color: var(--text); }
    .tbl-btn.danger { border-color: rgba(239,68,68,0.4); color: var(--red); }
    .tbl-btn.danger:hover { background: rgba(239,68,68,0.12); }
    .tbl-btn.active { background: var(--orange); border-color: var(--orange); color: #fff; }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }
    .data-table th {
      padding: 10px 16px;
      text-align: left; font-weight: 600;
      color: var(--text2); font-size: 0.7rem;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }
    .data-table td {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      vertical-align: middle;
    }
    .data-table tr:last-child td { border-bottom: none; }
    .data-table tr:hover td { background: rgba(255,255,255,0.03); }

    .badge {
      display: inline-flex; align-items: center;
      padding: 2px 8px; border-radius: 20px;
      font-size: 0.68rem; font-weight: 600;
    }
    .badge-orange { background: rgba(232,93,4,0.15); color: #f97316; }
    .badge-green  { background: rgba(34,197,94,0.15); color: #4ade80; }
    .badge-blue   { background: rgba(59,130,246,0.15); color: #60a5fa; }
    .badge-red    { background: rgba(239,68,68,0.15); color: #f87171; }
    .badge-gray   { background: rgba(148,163,184,0.15); color: #94a3b8; }
    .badge-purple { background: rgba(168,85,247,0.15); color: #c084fc; }

    .del-post-btn {
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid rgba(239,68,68,0.4);
      background: transparent;
      color: var(--red);
      font-size: 0.7rem; cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .del-post-btn:hover { background: rgba(239,68,68,0.15); }

    .truncate { 
      max-width: 200px; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      white-space: nowrap; 
    }

    /* ───── 페이지네이션 ───── */
    .pagination {
      display: flex; align-items: center; justify-content: center; gap: 6px;
      padding: 16px;
      border-top: 1px solid var(--border);
    }
    .page-btn {
      width: 32px; height: 32px;
      border-radius: 6px; border: 1px solid var(--border);
      background: transparent; color: var(--text2);
      font-size: 0.78rem; cursor: pointer;
      transition: all 0.2s;
      display: flex; align-items: center; justify-content: center;
    }
    .page-btn:hover { background: rgba(255,255,255,0.06); color: var(--text); }
    .page-btn.active { background: var(--orange); border-color: var(--orange); color: #fff; }
    .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }

    /* ───── 검색바 ───── */
    .search-bar {
      display: flex; gap: 10px; margin-bottom: 16px;
    }
    .search-input {
      flex: 1; padding: 8px 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 8px; color: var(--text);
      font-size: 0.82rem;
      outline: none;
      transition: border 0.2s;
    }
    .search-input::placeholder { color: var(--text2); }
    .search-input:focus { border-color: var(--orange); }
    .search-btn {
      padding: 8px 16px;
      background: var(--orange); color: #fff;
      border: none; border-radius: 8px;
      font-size: 0.82rem; cursor: pointer;
      transition: opacity 0.2s;
    }
    .search-btn:hover { opacity: 0.85; }

    /* ───── 필터 탭 ───── */
    .filter-tabs {
      display: flex; gap: 6px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .filter-tab {
      padding: 6px 14px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text2);
      font-size: 0.75rem; cursor: pointer;
      transition: all 0.2s;
    }
    .filter-tab:hover { border-color: var(--orange); color: var(--orange); }
    .filter-tab.active {
      background: var(--orange);
      border-color: var(--orange);
      color: #fff;
    }

    /* ───── 확인 모달 ───── */
    .modal-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--dark2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 28px;
      width: 360px;
      max-width: calc(100vw - 40px);
    }
    .modal h3 {
      font-size: 1rem; font-weight: 700;
      margin-bottom: 10px;
      display: flex; align-items: center; gap: 8px;
    }
    .modal h3 i { color: var(--red); }
    .modal p { color: var(--text2); font-size: 0.84rem; line-height: 1.6; margin-bottom: 20px; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
    .btn-cancel {
      padding: 9px 18px;
      border-radius: 8px; border: 1px solid var(--border);
      background: transparent; color: var(--text2);
      font-size: 0.82rem; cursor: pointer;
    }
    .btn-confirm-del {
      padding: 9px 18px;
      border-radius: 8px; border: none;
      background: var(--red); color: #fff;
      font-size: 0.82rem; cursor: pointer; font-weight: 600;
    }
    .btn-confirm-del:hover { opacity: 0.85; }

    /* ───── 토스트 ───── */
    #toastArea {
      position: fixed; bottom: 24px; right: 24px;
      display: flex; flex-direction: column; gap: 8px;
      z-index: 9000;
    }
    .toast {
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 0.82rem; font-weight: 500;
      animation: fadeInUp 0.25s ease;
      min-width: 240px;
    }
    .toast-success { background: #166534; border: 1px solid #16a34a; color: #bbf7d0; }
    .toast-error   { background: #7f1d1d; border: 1px solid #dc2626; color: #fecaca; }
    .toast-info    { background: #1e3a5f; border: 1px solid #3b82f6; color: #bfdbfe; }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ───── 빈 상태 ───── */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text2);
    }
    .empty-state i { font-size: 2rem; margin-bottom: 10px; display: block; opacity: 0.4; }
    .empty-state p { font-size: 0.84rem; }

    /* ───── 회원 관리 ───── */
    .avatar-circle {
      width: 32px; height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--orange), var(--orange2));
      display: flex; align-items: center; justify-content: center;
      font-size: 0.8rem; font-weight: 700; color: #fff;
      flex-shrink: 0;
    }
    .user-info { display: flex; align-items: center; gap: 10px; }

    /* ───── 반응형 ───── */
    @media (max-width: 860px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
      .chart-grid {
        grid-template-columns: 1fr;
      }
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .mobile-menu-toggle {
        display: flex !important;
      }
      .content-section {
        padding: 16px;
      }
      .top-bar {
        padding: 12px 16px;
      }
    }
    .mobile-menu-toggle {
      display: none;
      align-items: center; justify-content: center;
      width: 36px; height: 36px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer; color: var(--text);
    }
    .sidebar-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99;
    }
    .sidebar-overlay.open { display: block; }

    @media (max-width: 480px) {
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .stat-value { font-size: 1.6rem; }
      .data-table th:nth-child(4),
      .data-table td:nth-child(4) { display: none; }
    }
  </style>
</head>
<body>

<!-- 로딩 화면 -->
<div id="loadingScreen">
  <div class="spinner"></div>
  <p>관리자 권한 확인 중...</p>
</div>

<!-- 접근 거부 -->
<div id="accessDenied">
  <i class="fa-solid fa-shield-halved"></i>
  <h2>접근 권한이 없습니다</h2>
  <p>관리자만 이 페이지에 접근할 수 있습니다.</p>
  <a href="index.html"><i class="fa-solid fa-house"></i> 홈으로 돌아가기</a>
</div>

<!-- 확인 모달 -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <h3><i class="fa-solid fa-triangle-exclamation"></i> <span id="confirmTitle">삭제 확인</span></h3>
    <p id="confirmMessage">정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.</p>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">취소</button>
      <button class="btn-confirm-del" id="confirmBtn">삭제</button>
    </div>
  </div>
</div>

<!-- 토스트 -->
<div id="toastArea"></div>

<!-- 메인 앱 -->
<div id="adminApp">
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <div class="admin-layout">
    <!-- 사이드바 -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-logo">
        <a href="index.html" class="logo-badge">
          <i class="fa-solid fa-guitar"></i>
          코드덕쿠
          <span class="admin-tag">ADMIN</span>
        </a>
      </div>
      <div class="sidebar-user">
        <strong id="sidebarNickname">관리자</strong>
        <span id="sidebarEmail">로딩 중...</span>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section-label">대시보드</div>
        <a class="nav-item active" data-section="overview" onclick="showSection('overview')">
          <i class="fa-solid fa-gauge-high"></i> 대시보드 홈
        </a>

        <div class="nav-section-label">콘텐츠 관리</div>
        <a class="nav-item" data-section="posts" onclick="showSection('posts')">
          <i class="fa-solid fa-file-lines"></i> 게시물 관리
        </a>
        <a class="nav-item" data-section="comments" onclick="showSection('comments')">
          <i class="fa-solid fa-comments"></i> 댓글 관리
        </a>

        <div class="nav-section-label">회원 관리</div>
        <a class="nav-item" data-section="users" onclick="showSection('users')">
          <i class="fa-solid fa-users"></i> 회원 목록
        </a>
      </nav>
      <div class="sidebar-footer">
        <a href="index.html"><i class="fa-solid fa-arrow-left"></i> 사이트로 돌아가기</a>
        <a href="#" onclick="doSignOut()"><i class="fa-solid fa-right-from-bracket"></i> 로그아웃</a>
      </div>
    </aside>

    <!-- 메인 컨텐츠 -->
    <main class="main-content">
      <div class="top-bar">
        <div style="display:flex;align-items:center;gap:12px;">
          <div class="mobile-menu-toggle" onclick="openSidebar()">
            <i class="fa-solid fa-bars"></i>
          </div>
          <h1 id="pageTitle">대시보드 홈</h1>
        </div>
        <div class="top-bar-right">
          <div id="lastUpdated" style="font-size:0.7rem;color:var(--text2);">로딩 중...</div>
          <button class="refresh-btn" id="refreshBtn" onclick="refreshCurrentSection()">
            <i class="fa-solid fa-rotate-right"></i> 새로고침
          </button>
        </div>
      </div>

      <!-- ===== 대시보드 홈 ===== -->
      <section class="content-section active" id="section-overview">
        <div class="section-title">
          <i class="fa-solid fa-gauge-high"></i> 전체 현황 요약
        </div>

        <div class="stats-grid" id="statsGrid">
          <!-- JS로 채워짐 -->
          <div class="stat-card orange">
            <div class="stat-label"><i class="fa-solid fa-users"></i> 전체 회원수</div>
            <div class="stat-value" id="stat-users">-</div>
            <div class="stat-sub" id="stat-users-sub">로딩 중...</div>
            <i class="fa-solid fa-users stat-icon"></i>
          </div>
          <div class="stat-card green">
            <div class="stat-label"><i class="fa-solid fa-file-lines"></i> 전체 게시물</div>
            <div class="stat-value" id="stat-posts">-</div>
            <div class="stat-sub" id="stat-posts-sub">로딩 중...</div>
            <i class="fa-solid fa-file-lines stat-icon"></i>
          </div>
          <div class="stat-card blue">
            <div class="stat-label"><i class="fa-solid fa-comments"></i> 전체 댓글</div>
            <div class="stat-value" id="stat-comments">-</div>
            <div class="stat-sub" id="stat-comments-sub">로딩 중...</div>
            <i class="fa-solid fa-comments stat-icon"></i>
          </div>
          <div class="stat-card purple">
            <div class="stat-label"><i class="fa-solid fa-star"></i> 총 평가수</div>
            <div class="stat-value" id="stat-ratings">-</div>
            <div class="stat-sub" id="stat-ratings-sub">합주실/리페어샵 등</div>
            <i class="fa-solid fa-star stat-icon"></i>
          </div>
          <div class="stat-card yellow">
            <div class="stat-label"><i class="fa-solid fa-user-plus"></i> 7일 신규 가입</div>
            <div class="stat-value" id="stat-new-users">-</div>
            <div class="stat-sub">최근 7일 기준</div>
            <i class="fa-solid fa-user-plus stat-icon"></i>
          </div>
          <div class="stat-card red">
            <div class="stat-label"><i class="fa-solid fa-pen-to-square"></i> 7일 신규 게시물</div>
            <div class="stat-value" id="stat-new-posts">-</div>
            <div class="stat-sub">최근 7일 기준</div>
            <i class="fa-solid fa-pen-to-square stat-icon"></i>
          </div>
        </div>

        <!-- ── 방문자 현황 ── -->
        <div class="section-title" style="margin-top:4px;">
          <i class="fa-solid fa-eye"></i> 방문자 현황
          <span style="font-size:0.7rem;font-weight:400;color:var(--text2);margin-left:8px;">세션 기준 · 중복 제거</span>
        </div>
        <div class="stats-grid" id="visitStatsGrid" style="margin-bottom:28px;">
          <div class="stat-card teal">
            <div class="stat-label"><i class="fa-solid fa-calendar-day"></i> 오늘 방문자</div>
            <div class="stat-value" id="stat-visit-today">-</div>
            <div class="stat-sub" id="stat-visit-today-sub">로딩 중...</div>
            <i class="fa-solid fa-calendar-day stat-icon"></i>
          </div>
          <div class="stat-card indigo">
            <div class="stat-label"><i class="fa-solid fa-calendar-week"></i> 주간 방문자</div>
            <div class="stat-value" id="stat-visit-week">-</div>
            <div class="stat-sub">최근 7일</div>
            <i class="fa-solid fa-calendar-week stat-icon"></i>
          </div>
          <div class="stat-card cyan">
            <div class="stat-label"><i class="fa-solid fa-calendar"></i> 월간 방문자</div>
            <div class="stat-value" id="stat-visit-month">-</div>
            <div class="stat-sub">최근 30일</div>
            <i class="fa-solid fa-calendar stat-icon"></i>
          </div>
          <div class="stat-card purple">
            <div class="stat-label"><i class="fa-solid fa-chart-line"></i> 총 페이지뷰</div>
            <div class="stat-value" id="stat-visit-total">-</div>
            <div class="stat-sub">전체 누적</div>
            <i class="fa-solid fa-chart-line stat-icon"></i>
          </div>
        </div>

        <div class="chart-grid">
          <div class="chart-card">
            <h3><i class="fa-solid fa-chart-pie"></i> 카테고리별 게시물 분포</h3>
            <div class="chart-wrap">
              <canvas id="categoryChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3><i class="fa-solid fa-chart-bar"></i> 최근 7일 게시물 추이</h3>
            <div class="chart-wrap">
              <canvas id="trendChart"></canvas>
            </div>
          </div>
        </div>

        <!-- 방문자 추이 차트 (전체 너비) -->
        <div class="chart-card" style="margin-bottom:28px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
            <h3 style="margin-bottom:0;"><i class="fa-solid fa-users-viewfinder"></i> 일별 방문자 추이 (최근 14일)</h3>
            <div style="display:flex;gap:8px;">
              <button class="tbl-btn visitChartPeriod active" data-days="14" onclick="switchVisitChart(14,this)">14일</button>
              <button class="tbl-btn visitChartPeriod" data-days="30" onclick="switchVisitChart(30,this)">30일</button>
            </div>
          </div>
          <div style="height:240px;position:relative;">
            <canvas id="visitTrendChart"></canvas>
          </div>
        </div>

        <!-- 페이지별 방문 순위 -->
        <div class="chart-grid" style="margin-bottom:28px;">
          <div class="chart-card">
            <h3><i class="fa-solid fa-trophy"></i> 페이지별 방문 순위 (7일)</h3>
            <div style="height:220px;position:relative;">
              <canvas id="pageRankChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3><i class="fa-solid fa-clock"></i> 시간대별 방문 분포 (오늘)</h3>
            <div style="height:220px;position:relative;">
              <canvas id="hourlyChart"></canvas>
            </div>
          </div>
        </div>

        <!-- 최근 게시물 -->
        <div class="data-table-wrap">
          <div class="table-header">
            <h3><i class="fa-solid fa-clock-rotate-left"></i> 최근 게시물 (10개)</h3>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>카테고리</th>
                <th>제목</th>
                <th>작성자</th>
                <th>날짜</th>
                <th>관리</th>
              </tr>
            </thead>
            <tbody id="recentPostsTbl"></tbody>
          </table>
        </div>
      </section>

      <!-- ===== 게시물 관리 ===== -->
      <section class="content-section" id="section-posts">
        <div class="section-title">
          <i class="fa-solid fa-file-lines"></i> 게시물 관리
        </div>

        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;align-items:center;">
          <div class="search-bar" style="flex:1;min-width:200px;margin-bottom:0;">
            <input type="text" class="search-input" id="postSearchInput" placeholder="제목, 작성자 검색..." />
            <button class="search-btn" onclick="searchPosts()"><i class="fa-solid fa-search"></i></button>
          </div>
          <button class="tbl-btn danger" onclick="confirmBulkDelete()" style="white-space:nowrap;">
            <i class="fa-solid fa-trash"></i> 선택 삭제
          </button>
        </div>

        <div class="filter-tabs" id="postCatFilter">
          <button class="filter-tab active" data-cat="all" onclick="filterPosts('all')">전체</button>
          <button class="filter-tab" data-cat="free" onclick="filterPosts('free')">자유게시판</button>
          <button class="filter-tab" data-cat="gear" onclick="filterPosts('gear')">장비리뷰</button>
          <button class="filter-tab" data-cat="band" onclick="filterPosts('band')">밴드구인</button>
          <button class="filter-tab" data-cat="lesson" onclick="filterPosts('lesson')">개인레슨</button>
          <button class="filter-tab" data-cat="market" onclick="filterPosts('market')">중고장터</button>
          <button class="filter-tab" data-cat="used_gear" onclick="filterPosts('used_gear')">중고악기</button>
        </div>

        <div class="data-table-wrap">
          <div class="table-header">
            <h3><i class="fa-solid fa-list"></i> 게시물 목록</h3>
            <div class="table-actions">
              <span id="postTotalLabel" style="font-size:0.75rem;color:var(--text2);align-self:center;"></span>
            </div>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="checkAll" onchange="toggleCheckAll(this)" /></th>
                <th>카테고리</th>
                <th>제목</th>
                <th>작성자</th>
                <th>조회</th>
                <th>날짜</th>
                <th>삭제</th>
              </tr>
            </thead>
            <tbody id="postsTbl"></tbody>
          </table>
          <div class="pagination" id="postsPagination"></div>
        </div>
      </section>

      <!-- ===== 댓글 관리 ===== -->
      <section class="content-section" id="section-comments">
        <div class="section-title">
          <i class="fa-solid fa-comments"></i> 댓글 관리
        </div>

        <div class="search-bar">
          <input type="text" class="search-input" id="commentSearchInput" placeholder="댓글 내용, 작성자 검색..." />
          <button class="search-btn" onclick="searchComments()"><i class="fa-solid fa-search"></i></button>
        </div>

        <div class="data-table-wrap">
          <div class="table-header">
            <h3><i class="fa-solid fa-comment"></i> 댓글 목록</h3>
            <span id="commentTotalLabel" style="font-size:0.75rem;color:var(--text2);"></span>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>작성자</th>
                <th>내용</th>
                <th>게시물</th>
                <th>날짜</th>
                <th>삭제</th>
              </tr>
            </thead>
            <tbody id="commentsTbl"></tbody>
          </table>
          <div class="pagination" id="commentsPagination"></div>
        </div>
      </section>

      <!-- ===== 회원 관리 ===== -->
      <section class="content-section" id="section-users">
        <div class="section-title">
          <i class="fa-solid fa-users"></i> 회원 관리
        </div>

        <div class="search-bar">
          <input type="text" class="search-input" id="userSearchInput" placeholder="닉네임 검색..." />
          <button class="search-btn" onclick="searchUsers()"><i class="fa-solid fa-search"></i></button>
        </div>

        <div class="data-table-wrap">
          <div class="table-header">
            <h3><i class="fa-solid fa-user"></i> 회원 목록</h3>
            <span id="userTotalLabel" style="font-size:0.75rem;color:var(--text2);"></span>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>회원</th>
                <th>파트</th>
                <th>경력</th>
                <th>가입일</th>
                <th>등급</th>
              </tr>
            </thead>
            <tbody id="usersTbl"></tbody>
          </table>
          <div class="pagination" id="usersPagination"></div>
        </div>
      </section>

    </main>
  </div>
</div>

<!-- Supabase JS v2 + Auth.js -->
<script src="js/auth.js"></script>

<script>
// ============================================================
// 설정
// ============================================================
const SUPABASE_URL_ADM  = 'https://aubagaamktdmtvfabcbd.supabase.co';
const SUPABASE_ANON_ADM = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1YmFnYWFta3RkbXR2ZmFiY2JkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTc5NDksImV4cCI6MjA4Nzc3Mzk0OX0.XoKiaw8nCJc1Hq9OjiURrGi_ZA-6sU4xhqqpDGcC2IM';

const ADMIN_EMAIL = 'jihwan8012@naver.com';

let _sb = null;
function getSB() {
  if (!_sb && typeof supabase !== 'undefined') {
    _sb = supabase.createClient(SUPABASE_URL_ADM, SUPABASE_ANON_ADM);
  }
  return _sb;
}

const HDR = {
  'Content-Type': 'application/json',
  'apikey': SUPABASE_ANON_ADM,
  'Authorization': `Bearer ${SUPABASE_ANON_ADM}`,
  'Prefer': 'count=exact'
};

// ============================================================
// 상태
// ============================================================
let currentSection = 'overview';
let postsPage = 1, postsTotal = 0, postsCat = 'all', postsSearch = '';
let commentsPage = 1, commentsTotal = 0, commentsSearch = '';
let usersPage = 1, usersTotal = 0, usersSearch = '';
const PAGE_SIZE = 20;

let confirmCallback = null;
let categoryChart = null, trendChart = null;

// ============================================================
// 초기화: 관리자 확인
// ============================================================
async function init() {
  try {
    const sb = getSB();
    if (!sb) { showAccessDenied(); return; }

    const { data: { session } } = await sb.auth.getSession();
    if (!session) { showAccessDenied(); return; }

    const user = session.user;
    if (user.email !== ADMIN_EMAIL) { showAccessDenied(); return; }

    // profiles 테이블에서 is_admin 확인
    const res = await fetch(
      `${SUPABASE_URL_ADM}/rest/v1/profiles?id=eq.${user.id}&select=is_admin,nickname`,
      { headers: HDR }
    );
    const profiles = await res.json();
    if (!profiles.length || !profiles[0].is_admin) {
      showAccessDenied(); return;
    }

    // 관리자 확인 완료
    document.getElementById('sidebarEmail').textContent = user.email;
    document.getElementById('sidebarNickname').textContent = profiles[0].nickname || '관리자';
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('adminApp').style.display = 'block';

    await loadOverview();
    updateLastUpdated();

  } catch(e) {
    console.error(e);
    showAccessDenied();
  }
}

function showAccessDenied() {
  document.getElementById('loadingScreen').style.display = 'none';
  const el = document.getElementById('accessDenied');
  el.style.display = 'flex';
}

// ============================================================
// 섹션 전환
// ============================================================
const SECTION_TITLES = {
  overview: '대시보드 홈',
  posts: '게시물 관리',
  comments: '댓글 관리',
  users: '회원 관리'
};

async function showSection(name) {
  // 비활성화
  document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

  // 활성화
  document.getElementById('section-' + name).classList.add('active');
  document.querySelector(`.nav-item[data-section="${name}"]`).classList.add('active');
  document.getElementById('pageTitle').textContent = SECTION_TITLES[name];
  currentSection = name;

  closeSidebar();

  if (name === 'overview') { await loadOverview(); }
  else if (name === 'posts') { postsPage = 1; await loadPosts(); }
  else if (name === 'comments') { commentsPage = 1; await loadComments(); }
  else if (name === 'users') { usersPage = 1; await loadUsers(); }

  updateLastUpdated();
}

async function refreshCurrentSection() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('loading');
  try {
    await showSection(currentSection);
  } finally {
    btn.classList.remove('loading');
  }
}

// ============================================================
// 대시보드 홈
// ============================================================
async function loadOverview() {
  await Promise.all([
    fetchStats(),
    fetchVisitorStats(),
    loadRecentPosts()
  ]);
}

async function fetchStats() {
  try {
    // 게시물 수
    const rPosts = await fetch(
      `${SUPABASE_URL_ADM}/rest/v1/community_posts?status=eq.active&select=id,created_at,category`,
      { headers: HDR }
    );
    const posts = await rPosts.json();
    const totalPosts = posts.length;
    const now = Date.now();
    const week = 7 * 24 * 60 * 60 * 1000;
    const newPosts = posts.filter(p => (now - p.created_at) < week).length;
    document.getElementById('stat-posts').textContent = totalPosts.toLocaleString();
    document.getElementById('stat-posts-sub').textContent = `이번 주 +${newPosts}개`;
    document.getElementById('stat-new-posts').textContent = newPosts;

    // 댓글 수
    const rCom = await fetch(
      `${SUPABASE_URL_ADM}/rest/v1/community_comments?select=id,created_at`,
      { headers: HDR }
    );
    const comments = await rCom.json();
    document.getElementById('stat-comments').textContent = comments.length.toLocaleString();
    const newComments = comments.filter(c => (now - c.created_at) < week).length;
    document.getElementById('stat-comments-sub').textContent = `이번 주 +${newComments}개`;

    // 평가 수
    const rRat = await fetch(
      `${SUPABASE_URL_ADM}/rest/v1/ratings?select=id`,
      { headers: HDR }
    );
    const ratings = await rRat.json();
    document.getElementById('stat-ratings').textContent = ratings.length.toLocaleString();

    // 회원 수 (profiles)
    const rUsers = await fetch(
      `${SUPABASE_URL_ADM}/rest/v1/profiles?select=id,created_at`,
      { headers: HDR }
    );
    const users = await rUsers.json();
    document.getElementById('stat-users').textContent = users.length.toLocaleString();
    const newUsers = users.filter(u => u.created_at && (now - new Date(u.created_at).getTime()) < week).length;
    document.getElementById('stat-users-sub').textContent = `이번 주 +${newUsers}명`;
    document.getElementById('stat-new-users').textContent = newUsers;

    // 카테고리 차트
    buildCategoryChart(posts);
    // 트렌드 차트
    buildTrendChart(posts);

  } catch(e) {
    console.error('Stats error:', e);
  }
}

// ============================================================
// 방문자 통계
// ============================================================
let visitTrendChart = null, pageRankChart = null, hourlyChart = null;

async function fetchVisitorStats() {
  try {
    const now = Date.now();
    const todayStart  = new Date(); todayStart.setHours(0,0,0,0);
    const weekStart   = now - 7  * 86400000;
    const monthStart  = now - 30 * 86400000;

    // 전체 조회 (최근 30일치만 가져와 클라이언트에서 집계 — 성능 최적화)
    const res = await fetch(
      `${SUPABASE_URL_ADM}/rest/v1/page_views?visited_at=gte.${monthStart}&select=session_id,visited_at,page`,
      { headers: HDR }
    );
    const rows = await res.json();
    if (!Array.isArray(rows)) throw new Error('page_views fetch failed');

    // 총 페이지뷰 (전체)
    const totalRes = await fetch(
      `${SUPABASE_URL_ADM}/rest/v1/page_views?select=id`,
      { headers: { ...HDR, 'Prefer': 'count=exact' }, method: 'HEAD' }
    );
    const totalPV = parseInt(totalRes.headers.get('content-range')?.split('/')[1] || '0');

    // 세션 중복 제거 집계 함수
    const uniqueSessions = (arr) => new Set(arr.map(r => r.session_id)).size;

    const todayRows  = rows.filter(r => r.visited_at >= todayStart.getTime());
    const weekRows   = rows.filter(r => r.visited_at >= weekStart);
    const monthRows  = rows; // 이미 30일 필터링

    // 오늘 전일 비교
    const yestStart  = todayStart.getTime() - 86400000;
    const yestRows   = rows.filter(r => r.visited_at >= yestStart && r.visited_at < todayStart.getTime());
    const todayUV    = uniqueSessions(todayRows);
    const yestUV     = uniqueSessions(yestRows);
    const todayDiff  = todayUV - yestUV;

    document.getElementById('stat-visit-today').textContent  = todayUV.toLocaleString();
    document.getElementById('stat-visit-today-sub').textContent =
      `전일 대비 ${todayDiff >= 0 ? '+' : ''}${todayDiff}명`;
    document.getElementById('stat-visit-week').textContent   = uniqueSessions(weekRows).toLocaleString();
    document.getElementById('stat-visit-month').textContent  = uniqueSessions(monthRows).toLocaleString();
    document.getElementById('stat-visit-total').textContent  = totalPV.toLocaleString();

    // 차트 렌더
    buildVisitTrendChart(rows, 14);
    buildPageRankChart(weekRows);
    buildHourlyChart(todayRows);

  } catch(e) {
    console.error('Visitor stats error:', e);
    ['stat-visit-today','stat-visit-week','stat-visit-month','stat-visit-total'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.textContent = '오류';
    });
  }
}

// 일별 방문자 추이 차트
function buildVisitTrendChart(allRows, days) {
  const labels = [], counts = [];
  const now = Date.now();
  for (let i = days - 1; i >= 0; i--) {
    const dayStart = new Date(now - i * 86400000); dayStart.setHours(0,0,0,0);
    const dayEnd   = new Date(dayStart.getTime() + 86400000);
    const key = `${dayStart.getMonth()+1}/${dayStart.getDate()}`;
    labels.push(key);
    const dayRows = allRows.filter(r => r.visited_at >= dayStart.getTime() && r.visited_at < dayEnd.getTime());
    counts.push(new Set(dayRows.map(r => r.session_id)).size);
  }

  if (visitTrendChart) visitTrendChart.destroy();
  const ctx = document.getElementById('visitTrendChart').getContext('2d');
  const grad = ctx.createLinearGradient(0, 0, 0, 240);
  grad.addColorStop(0, 'rgba(6,182,212,0.35)');
  grad.addColorStop(1, 'rgba(6,182,212,0)');
  visitTrendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: '방문자(UV)',
        data: counts,
        borderColor: '#06b6d4',
        backgroundColor: grad,
        borderWidth: 2,
        pointRadius: 3,
        pointBackgroundColor: '#06b6d4',
        fill: true,
        tension: 0.4,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
        y: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true }
      }
    }
  });
}

// 기간 전환 버튼
function switchVisitChart(days, btn) {
  document.querySelectorAll('.visitChartPeriod').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  // 최근 30일 데이터를 다시 불러와 재렌더
  fetch(
    `${SUPABASE_URL_ADM}/rest/v1/page_views?visited_at=gte.${Date.now() - 30*86400000}&select=session_id,visited_at,page`,
    { headers: HDR }
  ).then(r => r.json()).then(rows => buildVisitTrendChart(rows, days));
}

// 페이지별 방문 순위 차트
function buildPageRankChart(rows) {
  const counts = {};
  rows.forEach(r => { counts[r.page] = (counts[r.page] || 0) + 1; });
  const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0, 8);
  const PAGE_KO = {
    index:'홈', community:'커뮤니티', rehearsal:'합주실', repair:'리페어샵',
    instrument:'악기샵', academy:'음악학원', venue:'공연장', score:'악보',
    analyze:'음원분석', portfolio:'포트폴리오', profile:'프로필',
    'video-review':'리뷰영상', 'video-cover':'카피영상',
    'video-fun':'재미영상', 'video-bandstage':'밴드라이브',
  };

  if (pageRankChart) pageRankChart.destroy();
  const ctx = document.getElementById('pageRankChart').getContext('2d');
  pageRankChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(([p]) => PAGE_KO[p] || p),
      datasets: [{
        data: sorted.map(([,c]) => c),
        backgroundColor: ['#e85d04','#3b82f6','#22c55e','#a855f7','#f59e0b','#06b6d4','#6366f1','#ef4444'],
        borderRadius: 4,
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true },
        y: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { display: false } }
      }
    }
  });
}

// 시간대별 방문 분포 차트 (오늘)
function buildHourlyChart(todayRows) {
  const counts = Array(24).fill(0);
  todayRows.forEach(r => {
    const h = new Date(r.visited_at).getHours();
    counts[h]++;
  });
  const labels = Array.from({length:24}, (_,i) => `${i}시`);

  if (hourlyChart) hourlyChart.destroy();
  const ctx = document.getElementById('hourlyChart').getContext('2d');
  hourlyChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data: counts,
        backgroundColor: 'rgba(99,102,241,0.7)',
        borderRadius: 3,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#94a3b8', font: { size: 9 }, maxRotation: 0 }, grid: { display: false } },
        y: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true }
      }
    }
  });
}


const CAT_LABELS = {
  free: '자유게시판', gear: '장비리뷰', band: '밴드구인',
  lesson: '개인레슨', market: '중고장터', used_gear: '중고악기'
};
const CAT_COLORS = ['#e85d04','#3b82f6','#22c55e','#a855f7','#f59e0b','#ef4444'];

function buildCategoryChart(posts) {
  const counts = {};
  posts.forEach(p => { counts[p.category] = (counts[p.category] || 0) + 1; });
  const labels = Object.keys(counts).map(k => CAT_LABELS[k] || k);
  const data   = Object.values(counts);

  if (categoryChart) categoryChart.destroy();
  const ctx = document.getElementById('categoryChart').getContext('2d');
  categoryChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{ data, backgroundColor: CAT_COLORS, borderWidth: 0 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#94a3b8', font: { size: 11 }, boxWidth: 12, padding: 10 }
        }
      }
    }
  });
}

function buildTrendChart(posts) {
  // 최근 7일 날짜별 게시물 수
  const days = [];
  const counts = {};
  for (let i = 6; i >= 0; i--) {
    const d = new Date(Date.now() - i * 86400000);
    const key = `${d.getMonth()+1}/${d.getDate()}`;
    days.push(key);
    counts[key] = 0;
  }
  posts.forEach(p => {
    const d = new Date(p.created_at);
    const key = `${d.getMonth()+1}/${d.getDate()}`;
    if (key in counts) counts[key]++;
  });

  if (trendChart) trendChart.destroy();
  const ctx = document.getElementById('trendChart').getContext('2d');
  trendChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: days,
      datasets: [{
        label: '게시물',
        data: days.map(d => counts[d]),
        backgroundColor: 'rgba(232,93,4,0.7)',
        borderRadius: 4
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
        y: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' }, beginAtZero: true }
      }
    }
  });
}

async function loadRecentPosts() {
  const res = await fetch(
    `${SUPABASE_URL_ADM}/rest/v1/community_posts?status=eq.active&order=created_at.desc&limit=10&select=id,title,author,category,created_at`,
    { headers: HDR }
  );
  const data = await res.json();
  const tbody = document.getElementById('recentPostsTbl');
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><i class="fa-solid fa-inbox"></i><p>게시물 없음</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = data.map(p => `
    <tr>
      <td><span class="badge ${catBadge(p.category)}">${CAT_LABELS[p.category]||p.category}</span></td>
      <td class="truncate" title="${escHtml(p.title)}">${escHtml(p.title)}</td>
      <td>${escHtml(p.author)}</td>
      <td style="white-space:nowrap;">${fmtDate(p.created_at)}</td>
      <td><button class="del-post-btn" onclick="confirmDeletePost('${p.id}','${escHtml(p.title).replace(/'/g,"\\'")}')"><i class="fa-solid fa-trash"></i> 삭제</button></td>
    </tr>
  `).join('');
}

// ============================================================
// 게시물 관리
// ============================================================
async function loadPosts() {
  const offset = (postsPage - 1) * PAGE_SIZE;
  let url = `${SUPABASE_URL_ADM}/rest/v1/community_posts?select=id,title,author,category,views,created_at,status&order=created_at.desc&limit=${PAGE_SIZE}&offset=${offset}`;
  if (postsCat !== 'all') url += `&category=eq.${postsCat}`;
  if (postsSearch) url += `&or=(title.ilike.*${postsSearch}*,author.ilike.*${postsSearch}*)`;

  // 카운트 쿼리
  let cntUrl = `${SUPABASE_URL_ADM}/rest/v1/community_posts?select=id`;
  if (postsCat !== 'all') cntUrl += `&category=eq.${postsCat}`;
  if (postsSearch) cntUrl += `&or=(title.ilike.*${postsSearch}*,author.ilike.*${postsSearch}*)`;

  const [res, cntRes] = await Promise.all([
    fetch(url, { headers: HDR }),
    fetch(cntUrl, { headers: { ...HDR, 'Prefer': 'count=exact' }, method: 'HEAD' })
  ]);
  const data = await res.json();
  const total = parseInt(cntRes.headers.get('content-range')?.split('/')[1] || '0');
  postsTotal = total;

  document.getElementById('postTotalLabel').textContent = `총 ${total}개`;
  document.getElementById('checkAll').checked = false;

  const tbody = document.getElementById('postsTbl');
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="fa-solid fa-inbox"></i><p>게시물 없음</p></div></td></tr>`;
  } else {
    tbody.innerHTML = data.map(p => `
      <tr>
        <td><input type="checkbox" class="post-check" value="${p.id}" /></td>
        <td><span class="badge ${catBadge(p.category)}">${CAT_LABELS[p.category]||p.category}</span></td>
        <td class="truncate" title="${escHtml(p.title)}">${escHtml(p.title)}</td>
        <td>${escHtml(p.author)}</td>
        <td>${p.views||0}</td>
        <td style="white-space:nowrap;">${fmtDate(p.created_at)}</td>
        <td><button class="del-post-btn" onclick="confirmDeletePost('${p.id}','${escHtml(p.title).replace(/'/g,"\\'")}')"><i class="fa-solid fa-trash"></i></button></td>
      </tr>
    `).join('');
  }
  renderPagination('postsPagination', postsPage, total, PAGE_SIZE, p => { postsPage = p; loadPosts(); });
}

function filterPosts(cat) {
  postsCat = cat;
  postsPage = 1;
  document.querySelectorAll('#postCatFilter .filter-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.cat === cat);
  });
  loadPosts();
}

function searchPosts() {
  postsSearch = document.getElementById('postSearchInput').value.trim();
  postsPage = 1;
  loadPosts();
}

document.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    if (document.activeElement.id === 'postSearchInput') searchPosts();
    if (document.activeElement.id === 'commentSearchInput') searchComments();
    if (document.activeElement.id === 'userSearchInput') searchUsers();
  }
});

function toggleCheckAll(el) {
  document.querySelectorAll('.post-check').forEach(c => c.checked = el.checked);
}

async function confirmBulkDelete() {
  const checked = [...document.querySelectorAll('.post-check:checked')].map(c => c.value);
  if (!checked.length) { showToast('삭제할 게시물을 선택하세요.', 'info'); return; }
  openModal(
    '선택 게시물 삭제',
    `선택한 ${checked.length}개의 게시물을 삭제합니다. 댓글도 함께 삭제됩니다. 계속하시겠습니까?`,
    async () => {
      for (const id of checked) await deletePost(id);
      showToast(`${checked.length}개 게시물 삭제 완료`, 'success');
      postsPage = 1; loadPosts(); loadOverview();
    }
  );
}

function confirmDeletePost(id, title) {
  openModal('게시물 삭제', `"${title}" 게시물을 삭제합니다. 이 작업은 되돌릴 수 없습니다.`, async () => {
    await deletePost(id);
    showToast('게시물이 삭제되었습니다.', 'success');
    if (currentSection === 'overview') loadOverview();
    else if (currentSection === 'posts') loadPosts();
  });
}

async function deletePost(id) {
  // 댓글 먼저 삭제
  await fetch(`${SUPABASE_URL_ADM}/rest/v1/community_comments?post_id=eq.${id}`, {
    method: 'DELETE', headers: HDR
  });
  // 게시물 삭제
  await fetch(`${SUPABASE_URL_ADM}/rest/v1/community_posts?id=eq.${id}`, {
    method: 'DELETE', headers: HDR
  });
}

// ============================================================
// 댓글 관리
// ============================================================
async function loadComments() {
  const offset = (commentsPage - 1) * PAGE_SIZE;
  let url = `${SUPABASE_URL_ADM}/rest/v1/community_comments?select=id,content,author,post_id,created_at&order=created_at.desc&limit=${PAGE_SIZE}&offset=${offset}`;
  if (commentsSearch) url += `&or=(content.ilike.*${commentsSearch}*,author.ilike.*${commentsSearch}*)`;

  let cntUrl = `${SUPABASE_URL_ADM}/rest/v1/community_comments?select=id`;
  if (commentsSearch) cntUrl += `&or=(content.ilike.*${commentsSearch}*,author.ilike.*${commentsSearch}*)`;

  const [res, cntRes] = await Promise.all([
    fetch(url, { headers: HDR }),
    fetch(cntUrl, { headers: { ...HDR, 'Prefer': 'count=exact' }, method: 'HEAD' })
  ]);
  const data = await res.json();
  const total = parseInt(cntRes.headers.get('content-range')?.split('/')[1] || '0');
  commentsTotal = total;

  document.getElementById('commentTotalLabel').textContent = `총 ${total}개`;

  const tbody = document.getElementById('commentsTbl');
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><i class="fa-solid fa-comment-slash"></i><p>댓글 없음</p></div></td></tr>`;
  } else {
    tbody.innerHTML = data.map(c => `
      <tr>
        <td>${escHtml(c.author)}</td>
        <td class="truncate" style="max-width:240px;" title="${escHtml(c.content)}">${escHtml(c.content)}</td>
        <td><span class="badge badge-gray" style="font-size:0.62rem;">${c.post_id.slice(0,8)}...</span></td>
        <td style="white-space:nowrap;">${fmtDate(c.created_at)}</td>
        <td><button class="del-post-btn" onclick="confirmDeleteComment('${c.id}')"><i class="fa-solid fa-trash"></i></button></td>
      </tr>
    `).join('');
  }
  renderPagination('commentsPagination', commentsPage, total, PAGE_SIZE, p => { commentsPage = p; loadComments(); });
}

function searchComments() {
  commentsSearch = document.getElementById('commentSearchInput').value.trim();
  commentsPage = 1;
  loadComments();
}

function confirmDeleteComment(id) {
  openModal('댓글 삭제', '이 댓글을 삭제하시겠습니까?', async () => {
    await fetch(`${SUPABASE_URL_ADM}/rest/v1/community_comments?id=eq.${id}`, {
      method: 'DELETE', headers: HDR
    });
    showToast('댓글이 삭제되었습니다.', 'success');
    loadComments();
  });
}

// ============================================================
// 회원 관리
// ============================================================
async function loadUsers() {
  const offset = (usersPage - 1) * PAGE_SIZE;
  let url = `${SUPABASE_URL_ADM}/rest/v1/profiles?select=id,nickname,parts,career,created_at,is_admin&order=created_at.desc&limit=${PAGE_SIZE}&offset=${offset}`;
  if (usersSearch) url += `&nickname.ilike.*${usersSearch}*`;

  let cntUrl = `${SUPABASE_URL_ADM}/rest/v1/profiles?select=id`;
  if (usersSearch) cntUrl += `&nickname.ilike.*${usersSearch}*`;

  const [res, cntRes] = await Promise.all([
    fetch(url, { headers: HDR }),
    fetch(cntUrl, { headers: { ...HDR, 'Prefer': 'count=exact' }, method: 'HEAD' })
  ]);
  const data = await res.json();
  const total = parseInt(cntRes.headers.get('content-range')?.split('/')[1] || '0');
  usersTotal = total;

  document.getElementById('userTotalLabel').textContent = `총 ${total}명`;

  const PART_MAP = { guitar:'기타', bass:'베이스', drum:'드럼', vocal:'보컬', keyboard:'키보드', other:'기타파트' };
  const CAREER_MAP = { beginner:'입문', novice:'초급', intermediate:'중급', advanced:'고급', expert:'전문가' };

  const tbody = document.getElementById('usersTbl');
  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><i class="fa-solid fa-user-slash"></i><p>회원 없음</p></div></td></tr>`;
  } else {
    tbody.innerHTML = data.map(u => `
      <tr>
        <td>
          <div class="user-info">
            <div class="avatar-circle">${(u.nickname||'?')[0].toUpperCase()}</div>
            <span>${escHtml(u.nickname||'이름없음')}</span>
          </div>
        </td>
        <td>${(u.parts||[]).map(p=>PART_MAP[p]||p).join(', ')||'-'}</td>
        <td>${CAREER_MAP[u.career]||u.career||'-'}</td>
        <td style="white-space:nowrap;">${u.created_at ? fmtDate(new Date(u.created_at).getTime()) : '-'}</td>
        <td>${u.is_admin ? '<span class="badge badge-orange"><i class="fa-solid fa-shield-halved"></i> 관리자</span>' : '<span class="badge badge-gray">일반</span>'}</td>
      </tr>
    `).join('');
  }
  renderPagination('usersPagination', usersPage, total, PAGE_SIZE, p => { usersPage = p; loadUsers(); });
}

function searchUsers() {
  usersSearch = document.getElementById('userSearchInput').value.trim();
  usersPage = 1;
  loadUsers();
}

// ============================================================
// 공통 유틸
// ============================================================
function catBadge(cat) {
  const map = { free:'badge-blue', gear:'badge-purple', band:'badge-green', lesson:'badge-orange', market:'badge-yellow', used_gear:'badge-red' };
  return map[cat] || 'badge-gray';
}

function fmtDate(ts) {
  if (!ts) return '-';
  const d = new Date(typeof ts === 'number' ? ts : ts);
  return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
}

function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function renderPagination(containerId, currentPage, total, size, onPage) {
  const totalPages = Math.ceil(total / size);
  const container = document.getElementById(containerId);
  if (totalPages <= 1) { container.innerHTML = ''; return; }

  const mkBtn = (p, label, disabled, active) =>
    `<button class="page-btn${active?' active':''}" data-page="${p}" ${disabled?'disabled':''}>${label}</button>`;

  let html = mkBtn(currentPage - 1, '<i class="fa-solid fa-chevron-left"></i>', currentPage === 1, false);

  const start = Math.max(1, currentPage - 2);
  const end   = Math.min(totalPages, currentPage + 2);
  if (start > 1) html += mkBtn(1, '1', false, false);
  if (start > 2) html += `<span style="color:var(--text2);padding:0 4px;">…</span>`;
  for (let i = start; i <= end; i++) {
    html += mkBtn(i, i, false, i === currentPage);
  }
  if (end < totalPages - 1) html += `<span style="color:var(--text2);padding:0 4px;">…</span>`;
  if (end < totalPages) html += mkBtn(totalPages, totalPages, false, false);
  html += mkBtn(currentPage + 1, '<i class="fa-solid fa-chevron-right"></i>', currentPage === totalPages, false);

  container.innerHTML = html;

  // 이벤트 위임
  container.querySelectorAll('.page-btn[data-page]').forEach(btn => {
    btn.addEventListener('click', () => {
      const p = parseInt(btn.dataset.page);
      if (!isNaN(p) && p >= 1 && p <= totalPages) onPage(p);
    });
  });
}

function showToast(msg, type = 'info') {
  const area = document.getElementById('toastArea');
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.textContent = msg;
  area.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

function openModal(title, msg, cb) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMessage').textContent = msg;
  confirmCallback = cb;
  document.getElementById('confirmModal').classList.add('open');
}

function closeModal() {
  document.getElementById('confirmModal').classList.remove('open');
  confirmCallback = null;
}

document.getElementById('confirmBtn').addEventListener('click', () => {
  if (confirmCallback) { confirmCallback(); closeModal(); }
});

function updateLastUpdated() {
  const now = new Date();
  document.getElementById('lastUpdated').textContent =
    `마지막 업데이트: ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
}

async function doSignOut() {
  const sb = getSB();
  if (sb) await sb.auth.signOut();
  window.location.href = 'login.html';
}

function openSidebar() {
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebarOverlay').classList.add('open');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('open');
}

// ============================================================
// 시작
// ============================================================
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
