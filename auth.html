<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#e85d04">
<title>ë¡œê·¸ì¸ / íšŒì›ê°€ì… â€” ì½”ë“œë•ì¿ </title>
<meta name="robots" content="noindex">
<link rel="icon" href="images/og-thumbnail.png" type="image/png">
<link rel="apple-touch-icon" href="images/og-thumbnail.png">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --accent:#e85d04;
  --accent-dark:#c24e03;
  --bg:#f8fafc;
  --bg-card:#ffffff;
  --border:#e2e8f0;
  --text:#1e293b;
  --text-sub:#64748b;
  --text-muted:#94a3b8;
  --radius:14px;
  --shadow:0 2px 12px rgba(0,0,0,0.07);
  --error:#dc2626;
  --success:#16a34a;
}
html{font-family:'Inter','Apple SD Gothic Neo',sans-serif;background:var(--bg);color:var(--text);}
body{min-height:100vh;display:flex;flex-direction:column;}

/* â”€â”€ í—¤ë” â”€â”€ */
.header{background:#fff;border-bottom:1px solid var(--border);padding:0 24px;height:56px;display:flex;align-items:center;}
.logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text);}
.logo i{font-size:1.3rem;color:var(--accent);}
.logo-text{font-size:1.1rem;font-weight:800;}
.logo-text .accent{color:var(--accent);}
.logo-ko{font-size:0.68rem;color:var(--text-muted);font-weight:600;letter-spacing:0.03em;}

/* â”€â”€ ë©”ì¸ â”€â”€ */
.main{flex:1;display:flex;align-items:center;justify-content:center;padding:40px 16px;}
.auth-card{
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  width:100%;
  max-width:480px;
  padding:36px 36px 32px;
}

/* â”€â”€ íƒ­ â”€â”€ */
.auth-tabs{display:flex;gap:0;margin-bottom:28px;border-bottom:2px solid var(--border);}
.auth-tab{flex:1;padding:10px 0;background:none;border:none;font-size:1rem;font-weight:700;color:var(--text-muted);cursor:pointer;transition:all .18s;position:relative;bottom:-2px;}
.auth-tab.active{color:var(--accent);border-bottom:2.5px solid var(--accent);}

/* â”€â”€ í¼ â”€â”€ */
.form-section{display:none;}
.form-section.active{display:block;}
.form-title{font-size:1.3rem;font-weight:800;margin-bottom:6px;}
.form-desc{font-size:0.85rem;color:var(--text-sub);margin-bottom:24px;line-height:1.6;}

.form-group{margin-bottom:16px;}
.form-label{display:block;font-size:0.83rem;font-weight:600;color:var(--text);margin-bottom:6px;}
.form-label .required{color:var(--accent);margin-left:2px;}
.form-label .optional{color:var(--text-muted);font-weight:400;font-size:0.78rem;margin-left:4px;}
.form-input{
  width:100%;padding:11px 14px;
  border:1.5px solid var(--border);
  border-radius:10px;
  font-size:0.93rem;
  color:var(--text);
  background:#fff;
  outline:none;
  transition:border-color .18s;
}
.form-input:focus{border-color:var(--accent);}
.form-input.error{border-color:var(--error);}

/* â”€â”€ ì„±ë³„ ì„ íƒ â”€â”€ */
.gender-group{display:flex;gap:10px;}
.gender-btn{
  flex:1;padding:10px 0;
  border:1.5px solid var(--border);
  border-radius:10px;
  background:#fff;
  font-size:0.9rem;font-weight:600;
  color:var(--text-sub);
  cursor:pointer;
  transition:all .18s;
  display:flex;align-items:center;justify-content:center;gap:6px;
}
.gender-btn:hover{border-color:var(--accent);color:var(--accent);}
.gender-btn.selected{border-color:var(--accent);background:#fff7f0;color:var(--accent);}

/* â”€â”€ íŒŒíŠ¸ ì„ íƒ â”€â”€ */
.part-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.part-btn{
  padding:9px 6px;
  border:1.5px solid var(--border);
  border-radius:10px;
  background:#fff;
  font-size:0.82rem;font-weight:600;
  color:var(--text-sub);
  cursor:pointer;
  transition:all .18s;
  text-align:center;
  line-height:1.4;
}
.part-btn:hover{border-color:var(--accent);color:var(--accent);}
.part-btn.selected{border-color:var(--accent);background:#fff7f0;color:var(--accent);}
.part-btn .part-icon{display:block;font-size:1.2rem;margin-bottom:3px;}

/* â”€â”€ ê²½ë ¥ ì„ íƒ â”€â”€ */
.career-select{
  width:100%;padding:11px 14px;
  border:1.5px solid var(--border);
  border-radius:10px;
  font-size:0.93rem;
  color:var(--text);
  background:#fff;
  outline:none;
  cursor:pointer;
  transition:border-color .18s;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 14px center;
  padding-right:36px;
}
.career-select:focus{border-color:var(--accent);}

/* â”€â”€ ë²„íŠ¼ â”€â”€ */
.submit-btn{
  width:100%;padding:13px;
  background:var(--accent);
  color:#fff;
  border:none;border-radius:10px;
  font-size:1rem;font-weight:700;
  cursor:pointer;
  transition:all .2s;
  margin-top:8px;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.submit-btn:hover{background:var(--accent-dark);transform:translateY(-1px);}
.submit-btn:disabled{background:#cbd5e1;cursor:not-allowed;transform:none;}

/* â”€â”€ ë©”ì‹œì§€ â”€â”€ */
.msg-box{
  padding:12px 14px;
  border-radius:10px;
  font-size:0.85rem;
  font-weight:600;
  margin-bottom:16px;
  display:none;
  align-items:flex-start;
  gap:8px;
  line-height:1.5;
}
.msg-box.error{background:#fef2f2;border:1px solid #fecaca;color:var(--error);display:flex;}
.msg-box.success{background:#f0fdf4;border:1px solid #bbf7d0;color:var(--success);display:flex;}

/* â”€â”€ êµ¬ë¶„ì„  â”€â”€ */
.divider{display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--text-muted);font-size:0.8rem;}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border);}

/* â”€â”€ ë§í¬ â”€â”€ */
.auth-link{text-align:center;font-size:0.84rem;color:var(--text-sub);margin-top:16px;}
.auth-link a{color:var(--accent);font-weight:700;text-decoration:none;}
.auth-link a:hover{text-decoration:underline;}

/* â”€â”€ ë¹„ë°€ë²ˆí˜¸ í† ê¸€ â”€â”€ */
.input-wrap{position:relative;}
.input-wrap .form-input{padding-right:42px;}
.pw-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.9rem;padding:4px;}

/* â”€â”€ ì¸ì¦ ì™„ë£Œ í™”ë©´ â”€â”€ */
.verify-screen{text-align:center;padding:20px 0;}
.verify-icon{font-size:3.5rem;margin-bottom:16px;}
.verify-title{font-size:1.2rem;font-weight:800;margin-bottom:8px;}
.verify-desc{font-size:0.88rem;color:var(--text-sub);line-height:1.7;}
.verify-email{display:inline-block;background:#fff7f0;color:var(--accent);font-weight:700;padding:4px 12px;border-radius:8px;margin:8px 0;}

/* â”€â”€ ìŠ¤í… ì¸ë””ì¼€ì´í„° â”€â”€ */
.step-indicator{display:flex;align-items:center;gap:0;margin-bottom:24px;}
.step{display:flex;align-items:center;gap:6px;font-size:0.8rem;font-weight:600;color:var(--text-muted);}
.step.active{color:var(--accent);}
.step.done{color:var(--success);}
.step-num{width:24px;height:24px;border-radius:50%;border:2px solid currentColor;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:800;flex-shrink:0;}
.step.done .step-num{background:var(--success);border-color:var(--success);color:#fff;}
.step.active .step-num{background:var(--accent);border-color:var(--accent);color:#fff;}
.step-line{flex:1;height:2px;background:var(--border);margin:0 6px;}
.step-line.done{background:var(--success);}

/* â”€â”€ ë°˜ì‘í˜• â”€â”€ */
@media(max-width:520px){
  .auth-card{padding:24px 18px 20px;}
  .part-grid{grid-template-columns:repeat(3,1fr);}
}
</style>
</head>
<body>

<!-- í—¤ë” -->
<header class="header">
  <a href="index.html" class="logo">
    <i class="fas fa-guitar"></i>
    <div>
      <div class="logo-text">Code<span class="accent">ducku</span></div>
      <div class="logo-ko">ì½”ë“œë•ì¿ </div>
    </div>
  </a>
</header>

<!-- ë©”ì¸ -->
<main class="main">
  <div class="auth-card">

    <!-- íƒ­ -->
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin" onclick="switchTab('login')">ë¡œê·¸ì¸</button>
      <button class="auth-tab" id="tabSignup" onclick="switchTab('signup')">íšŒì›ê°€ì…</button>
    </div>

    <!-- â”€â”€â”€â”€â”€ ë¡œê·¸ì¸ í¼ â”€â”€â”€â”€â”€ -->
    <div class="form-section active" id="loginSection">
      <div class="msg-box" id="loginMsg"></div>
      <div class="form-group">
        <label class="form-label">ì´ë©”ì¼<span class="required">*</span></label>
        <input class="form-input" type="email" id="loginEmail" placeholder="ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥" autocomplete="email">
      </div>
      <div class="form-group">
        <label class="form-label">ë¹„ë°€ë²ˆí˜¸<span class="required">*</span></label>
        <div class="input-wrap">
          <input class="form-input" type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password">
          <button class="pw-toggle" onclick="togglePw('loginPw',this)" type="button"><i class="fas fa-eye"></i></button>
        </div>
      </div>
      <button class="submit-btn" id="loginBtn" onclick="doLogin()">
        <i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸
      </button>
      <div class="auth-link" style="margin-top:12px;">
        <a href="#" onclick="showForgotPw(event)">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</a>
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€ íšŒì›ê°€ì… í¼ â”€â”€â”€â”€â”€ -->
    <div class="form-section" id="signupSection">

      <!-- ìŠ¤í… ì¸ë””ì¼€ì´í„° -->
      <div class="step-indicator" id="stepIndicator">
        <div class="step active" id="step1El">
          <div class="step-num">1</div>
          <span>ê³„ì • ì •ë³´</span>
        </div>
        <div class="step-line" id="stepLine1"></div>
        <div class="step" id="step2El">
          <div class="step-num">2</div>
          <span>í”„ë¡œí•„ ì„¤ì •</span>
        </div>
        <div class="step-line" id="stepLine2"></div>
        <div class="step" id="step3El">
          <div class="step-num">3</div>
          <span>ì´ë©”ì¼ ì¸ì¦</span>
        </div>
      </div>

      <div class="msg-box" id="signupMsg"></div>

      <!-- STEP 1: ê³„ì • ì •ë³´ -->
      <div id="signupStep1">
        <div class="form-title">ê³„ì • ì •ë³´ ì…ë ¥</div>
        <div class="form-desc">ë¡œê·¸ì¸ì— ì‚¬ìš©í•  ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš”.</div>
        <div class="form-group">
          <label class="form-label">ì´ë©”ì¼<span class="required">*</span></label>
          <input class="form-input" type="email" id="signupEmail" placeholder="ì´ë©”ì¼ ì£¼ì†Œ ì…ë ¥" autocomplete="email">
        </div>
        <div class="form-group">
          <label class="form-label">ë¹„ë°€ë²ˆí˜¸<span class="required">*</span></label>
          <div class="input-wrap">
            <input class="form-input" type="password" id="signupPw" placeholder="8ì ì´ìƒ ì…ë ¥" autocomplete="new-password">
            <button class="pw-toggle" onclick="togglePw('signupPw',this)" type="button"><i class="fas fa-eye"></i></button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸<span class="required">*</span></label>
          <div class="input-wrap">
            <input class="form-input" type="password" id="signupPwConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥" autocomplete="new-password">
            <button class="pw-toggle" onclick="togglePw('signupPwConfirm',this)" type="button"><i class="fas fa-eye"></i></button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ë‹‰ë„¤ì„<span class="required">*</span></label>
          <input class="form-input" type="text" id="signupNick" placeholder="2~12ì (í•œê¸€, ì˜ë¬¸, ìˆ«ì)" maxlength="12">
        </div>
        <button class="submit-btn" onclick="goStep2()">
          ë‹¤ìŒ <i class="fas fa-arrow-right"></i>
        </button>
      </div>

      <!-- STEP 2: í”„ë¡œí•„ -->
      <div id="signupStep2" style="display:none;">
        <div class="form-title">ìŒì•… í”„ë¡œí•„ ì„¤ì •</div>
        <div class="form-desc">ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ì‚¬ìš©í•  ìŒì•… í”„ë¡œí•„ì„ ì„¤ì •í•˜ì„¸ìš”.</div>

        <!-- ì„±ë³„ -->
        <div class="form-group">
          <label class="form-label">ì„±ë³„<span class="required">*</span></label>
          <div class="gender-group">
            <button class="gender-btn" data-val="male" onclick="selectGender(this)">
              <i class="fas fa-mars"></i> ë‚¨ì„±
            </button>
            <button class="gender-btn" data-val="female" onclick="selectGender(this)">
              <i class="fas fa-venus"></i> ì—¬ì„±
            </button>
            <button class="gender-btn" data-val="other" onclick="selectGender(this)">
              <i class="fas fa-genderless"></i> ê¸°íƒ€
            </button>
          </div>
        </div>

        <!-- íŒŒíŠ¸ (ì¤‘ë³µ ì„ íƒ) -->
        <div class="form-group">
          <label class="form-label">íŒŒíŠ¸<span class="required">*</span> <span style="font-size:0.78rem;font-weight:400;color:var(--text-muted);">ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥</span></label>
          <div class="part-grid">
            <button class="part-btn" data-val="vocal" onclick="togglePart(this)">
              <span class="part-icon">ğŸ¤</span>ë³´ì»¬
            </button>
            <button class="part-btn" data-val="guitar_electric" onclick="togglePart(this)">
              <span class="part-icon">ğŸ¸</span>ì¼ë ‰ê¸°íƒ€
            </button>
            <button class="part-btn" data-val="guitar_acoustic" onclick="togglePart(this)">
              <span class="part-icon">ğŸª•</span>ì–´ì¿ ìŠ¤í‹±
            </button>
            <button class="part-btn" data-val="bass" onclick="togglePart(this)">
              <span class="part-icon">ğŸµ</span>ë² ì´ìŠ¤
            </button>
            <button class="part-btn" data-val="drum" onclick="togglePart(this)">
              <span class="part-icon">ğŸ¥</span>ë“œëŸ¼
            </button>
            <button class="part-btn" data-val="keyboard" onclick="togglePart(this)">
              <span class="part-icon">ğŸ¹</span>í‚¤ë³´ë“œ
            </button>
            <button class="part-btn" data-val="dj" onclick="togglePart(this)">
              <span class="part-icon">ğŸ§</span>DJ
            </button>
            <button class="part-btn" data-val="brass" onclick="togglePart(this)">
              <span class="part-icon">ğŸº</span>ê´€ì•…ê¸°
            </button>
            <button class="part-btn" data-val="etc" onclick="togglePart(this)">
              <span class="part-icon">ğŸ¼</span>ê¸°íƒ€
            </button>
          </div>
        </div>

        <!-- ìŒì•… ê²½ë ¥ -->
        <div class="form-group">
          <label class="form-label">ìŒì•… ê²½ë ¥ <span class="optional">(ì„ íƒ)</span></label>
          <select class="career-select" id="signupCareer">
            <option value="">ê²½ë ¥ ì„ íƒ ì•ˆí•¨</option>
            <option value="beginner">ì…ë¬¸ (1ë…„ ë¯¸ë§Œ)</option>
            <option value="1to3">ì´ˆê¸‰ (1~3ë…„)</option>
            <option value="3to5">ì¤‘ê¸‰ (3~5ë…„)</option>
            <option value="5to10">ê³ ê¸‰ (5~10ë…„)</option>
            <option value="10plus">ì „ë¬¸ê°€ (10ë…„ ì´ìƒ)</option>
          </select>
        </div>

        <div style="display:flex;gap:10px;">
          <button class="submit-btn" style="background:#f1f5f9;color:var(--text);flex:0 0 auto;width:auto;padding:13px 20px;" onclick="goStep1()">
            <i class="fas fa-arrow-left"></i>
          </button>
          <button class="submit-btn" id="signupSubmitBtn" onclick="doSignup()" style="flex:1;">
            <i class="fas fa-envelope"></i> ì¸ì¦ ë©”ì¼ ë°œì†¡
          </button>
        </div>
      </div>

      <!-- STEP 3: ì´ë©”ì¼ ì¸ì¦ ëŒ€ê¸° -->
      <div id="signupStep3" style="display:none;">
        <div class="verify-screen">
          <div class="verify-icon">ğŸ“§</div>
          <div class="verify-title">ì¸ì¦ ë©”ì¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤!</div>
          <div class="verify-desc">
            ì•„ë˜ ì´ë©”ì¼ë¡œ ì¸ì¦ ë§í¬ë¥¼ ë°œì†¡í–ˆì–´ìš”.<br>
            <span class="verify-email" id="verifyEmailDisplay"></span><br>
            ë©”ì¼í•¨ì„ í™•ì¸í•˜ê³  ë§í¬ë¥¼ í´ë¦­í•˜ë©´<br>
            <strong>ê°€ì…ì´ ì™„ë£Œ</strong>ë©ë‹ˆë‹¤ ğŸ¸
          </div>
          <div style="margin-top:20px;font-size:0.82rem;color:var(--text-muted);">
            ë©”ì¼ì´ ì•ˆ ë³´ì´ë©´ ìŠ¤íŒ¸í•¨ì„ í™•ì¸í•˜ê±°ë‚˜<br>
            <a href="#" onclick="resendEmail(event)" style="color:var(--accent);font-weight:700;">ì¸ì¦ ë©”ì¼ ì¬ë°œì†¡</a>
          </div>
        </div>
      </div>

    </div><!-- /signupSection -->

  </div><!-- /auth-card -->
</main>

<!-- Supabase JS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://aubagaamktdmtvfabcbd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1YmFnYWFta3RkbXR2ZmFiY2JkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTc5NDksImV4cCI6MjA4Nzc3Mzk0OX0.XoKiaw8nCJc1Hq9OjiURrGi_ZA-6sU4xhqqpDGcC2IM';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ì´ë¯¸ ë¡œê·¸ì¸ ìƒíƒœë©´ ì»¤ë®¤ë‹ˆí‹°ë¡œ ì´ë™
sb.auth.getSession().then(({ data }) => {
  if (data.session) window.location.href = 'community.html';
});

// ì´ë©”ì¼ ì¸ì¦ í›„ ëŒì•„ì™”ì„ ë•Œ ì²˜ë¦¬
const hashParams = new URLSearchParams(window.location.hash.replace('#','?').slice(1));
if (hashParams.get('type') === 'signup' || hashParams.get('access_token')) {
  showMsg('loginMsg','success','âœ… ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
  switchTab('login');
}

/* â”€â”€ ìƒíƒœ â”€â”€ */
let selectedGender = '';
let selectedParts  = new Set();

/* â”€â”€ íƒ­ ì „í™˜ â”€â”€ */
function switchTab(tab) {
  document.getElementById('loginSection').classList.toggle('active', tab === 'login');
  document.getElementById('signupSection').classList.toggle('active', tab === 'signup');
  document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
  document.getElementById('tabSignup').classList.toggle('active', tab === 'signup');
  clearMsg('loginMsg'); clearMsg('signupMsg');
}

/* â”€â”€ ë¹„ë°€ë²ˆí˜¸ í† ê¸€ â”€â”€ */
function togglePw(id, btn) {
  const inp = document.getElementById(id);
  const isHidden = inp.type === 'password';
  inp.type = isHidden ? 'text' : 'password';
  btn.innerHTML = isHidden ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
}

/* â”€â”€ ë©”ì‹œì§€ â”€â”€ */
function showMsg(id, type, text) {
  const el = document.getElementById(id);
  el.className = `msg-box ${type}`;
  el.innerHTML = `<i class="fas fa-${type==='error'?'exclamation-circle':'check-circle'}"></i> ${text}`;
}
function clearMsg(id) {
  const el = document.getElementById(id);
  el.className = 'msg-box';
  el.innerHTML = '';
}

/* â”€â”€ ì„±ë³„ ì„ íƒ â”€â”€ */
function selectGender(btn) {
  document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedGender = btn.dataset.val;
}

/* â”€â”€ íŒŒíŠ¸ í† ê¸€ â”€â”€ */
function togglePart(btn) {
  btn.classList.toggle('selected');
  const val = btn.dataset.val;
  if (selectedParts.has(val)) selectedParts.delete(val);
  else selectedParts.add(val);
}

/* â”€â”€ STEP ì´ë™ â”€â”€ */
function goStep1() {
  document.getElementById('signupStep1').style.display = 'block';
  document.getElementById('signupStep2').style.display = 'none';
  // ìŠ¤í… ì¸ë””ì¼€ì´í„°
  setStep(1);
}
function goStep2() {
  clearMsg('signupMsg');
  const email = document.getElementById('signupEmail').value.trim();
  const pw    = document.getElementById('signupPw').value;
  const pwc   = document.getElementById('signupPwConfirm').value;
  const nick  = document.getElementById('signupNick').value.trim();

  if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    return showMsg('signupMsg','error','ì˜¬ë°”ë¥¸ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  }
  if (pw.length < 8) {
    return showMsg('signupMsg','error','ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
  }
  if (pw !== pwc) {
    return showMsg('signupMsg','error','ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  }
  if (nick.length < 2) {
    return showMsg('signupMsg','error','ë‹‰ë„¤ì„ì€ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
  }

  document.getElementById('signupStep1').style.display = 'none';
  document.getElementById('signupStep2').style.display = 'block';
  setStep(2);
}

function setStep(n) {
  [1,2,3].forEach(i => {
    const el = document.getElementById(`step${i}El`);
    el.className = 'step' + (i < n ? ' done' : i === n ? ' active' : '');
  });
  if (document.getElementById('stepLine1'))
    document.getElementById('stepLine1').className = 'step-line' + (n > 1 ? ' done' : '');
  if (document.getElementById('stepLine2'))
    document.getElementById('stepLine2').className = 'step-line' + (n > 2 ? ' done' : '');
}

/* â”€â”€ ë¡œê·¸ì¸ â”€â”€ */
async function doLogin() {
  clearMsg('loginMsg');
  const email = document.getElementById('loginEmail').value.trim();
  const pw    = document.getElementById('loginPw').value;

  if (!email || !pw) return showMsg('loginMsg','error','ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');

  const btn = document.getElementById('loginBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë¡œê·¸ì¸ ì¤‘...';

  const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });

  if (error) {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸';
    const msg = error.message.includes('Invalid') ? 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.' :
                error.message.includes('confirm') ? 'ì´ë©”ì¼ ì¸ì¦ í›„ ë¡œê·¸ì¸í•˜ì„¸ìš”.' :
                error.message;
    return showMsg('loginMsg','error', msg);
  }

  // ë¡œê·¸ì¸ ì„±ê³µ
  const redirect = new URLSearchParams(window.location.search).get('from') || 'community.html';
  window.location.href = redirect;
}

/* â”€â”€ íšŒì›ê°€ì… â”€â”€ */
async function doSignup() {
  clearMsg('signupMsg');

  if (!selectedGender) {
    return showMsg('signupMsg','error','ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
  }
  if (selectedParts.size === 0) {
    return showMsg('signupMsg','error','íŒŒíŠ¸ë¥¼ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
  }

  const email  = document.getElementById('signupEmail').value.trim();
  const pw     = document.getElementById('signupPw').value;
  const nick   = document.getElementById('signupNick').value.trim();
  const career = document.getElementById('signupCareer').value;

  const btn = document.getElementById('signupSubmitBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì²˜ë¦¬ ì¤‘...';

  const { data, error } = await sb.auth.signUp({
    email,
    password: pw,
    options: {
      emailRedirectTo: window.location.origin + '/auth.html',
      data: {
        nickname: nick,
        gender:   selectedGender,
        parts:    Array.from(selectedParts),
        career:   career || null,
      }
    }
  });

  btn.disabled = false;
  btn.innerHTML = '<i class="fas fa-envelope"></i> ì¸ì¦ ë©”ì¼ ë°œì†¡';

  if (error) {
    const msg = error.message.includes('already') ? 'ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.' : error.message;
    return showMsg('signupMsg','error', msg);
  }

  // ì„±ê³µ â†’ STEP 3
  document.getElementById('signupStep2').style.display = 'none';
  document.getElementById('signupStep3').style.display = 'block';
  document.getElementById('verifyEmailDisplay').textContent = email;
  setStep(3);
  window._signupEmail = email;
  window._signupPw    = pw;
}

/* â”€â”€ ì¸ì¦ ë©”ì¼ ì¬ë°œì†¡ â”€â”€ */
async function resendEmail(e) {
  e.preventDefault();
  if (!window._signupEmail) return;
  await sb.auth.resend({ type: 'signup', email: window._signupEmail });
  alert('ì¸ì¦ ë©”ì¼ì„ ì¬ë°œì†¡í–ˆìŠµë‹ˆë‹¤. ìŠ¤íŒ¸í•¨ë„ í™•ì¸í•´ì£¼ì„¸ìš”.');
}

/* â”€â”€ ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° â”€â”€ */
async function showForgotPw(e) {
  e.preventDefault();
  const email = document.getElementById('loginEmail').value.trim();
  if (!email) {
    return showMsg('loginMsg','error','ì´ë©”ì¼ì„ ë¨¼ì € ì…ë ¥í•œ í›„ í´ë¦­í•˜ì„¸ìš”.');
  }
  const { error } = await sb.auth.resetPasswordForEmail(email, {
    redirectTo: window.location.origin + '/auth.html'
  });
  if (error) return showMsg('loginMsg','error', error.message);
  showMsg('loginMsg','success','ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë©”ì¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.');
}

/* â”€â”€ Enter í‚¤ â”€â”€ */
document.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  const loginActive = document.getElementById('loginSection').classList.contains('active');
  if (loginActive) doLogin();
});
</script>
</body>
</html>
